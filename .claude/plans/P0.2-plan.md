# Module P0.2 Implementation Plan

**Module:** Serena MCP Wiring and Validation
**Phase:** Phase 0 - Platform Scaffolding
**Created:** 2025-11-22
**Estimated Total Time:** 1.5 hours

---

## Summary

This module validates that Serena MCP memory persistence is working correctly across agent sessions. We will create test scripts to write, read, and validate the three primary memory types (system-context, progress-tracker, module-state), ensuring that state survives agent restarts. Documentation will be created to guide future memory usage patterns and troubleshoot common issues.

The module is validation-focused with no UI components. All tests are command-line scripts using Node.js and Serena MCP tools. Success means we have confidence in Serena's reliability for autonomous multi-agent execution.

---

## Tasks

### Task 1: Create tests/serena directory structure

**Description:** Create the directory structure for Serena validation tests
**Files:**
- Create `tests/serena/` directory

**Success Criteria:**
- Directory exists at `tests/serena/`
- Ready to hold test scripts

**Estimated Complexity:** Small
**Dependencies:** None

---

### Task 2: Create memory write test script

**Description:** Create a Node.js script that writes test data to all three Serena memory types (system-context, progress-tracker, module-P0.2-state)
**Files:**
- Create `tests/serena/memory-write-test.js`

**Test Data to Write:**
- `takeoff-system-context-test` - Test system state with timestamp
- `takeoff-progress-tracker-test` - Test progress entry with timestamp
- `takeoff-module-P0.2-state-test` - Test module state with timestamp

**Success Criteria:**
- Script runs without errors: `node tests/serena/memory-write-test.js`
- Writes unique timestamp to each test memory
- Prints confirmation of successful writes
- Uses Serena `write_memory` tool correctly

**Estimated Complexity:** Medium
**Dependencies:** Task 1

---

### Task 3: Create memory read test script

**Description:** Create a Node.js script that reads and validates the test memories created in Task 2
**Files:**
- Create `tests/serena/memory-read-test.js`

**Validation Logic:**
- Read all three test memories
- Verify content matches expected structure
- Print PASS/FAIL for each memory type
- Return exit code 0 for pass, 1 for fail

**Success Criteria:**
- Script runs without errors: `node tests/serena/memory-read-test.js`
- Reads all three test memories successfully
- Validates data structure and content
- Prints clear PASS/FAIL output
- Can detect mismatches or missing data

**Estimated Complexity:** Medium
**Dependencies:** Task 2 (write script must exist and have been run)

---

### Task 4: Create session persistence test script

**Description:** Create a test that validates memory survives agent restart by writing a unique timestamp and verifying it after restart
**Files:**
- Create `tests/serena/memory-persistence-test.js`

**Test Flow:**
1. Check if `takeoff-persistence-test` memory exists
2. If not exists: Write unique timestamp and print "STOP AGENT NOW - Restart and run again"
3. If exists: Read timestamp, verify it matches, print PASS if identical

**Success Criteria:**
- Script runs in two modes (write + read)
- Detects whether it's first run or second run
- Prints clear instructions for agent restart
- Validates timestamp survives restart
- Prints PASS/FAIL based on persistence test

**Estimated Complexity:** Medium
**Dependencies:** Tasks 2 and 3 (understand write/read patterns)

---

### Task 5: Create docs/takeoff/serena directory structure

**Description:** Create the directory structure for Serena-specific documentation
**Files:**
- Create `docs/takeoff/serena/` directory

**Success Criteria:**
- Directory exists at `docs/takeoff/serena/`
- Ready to hold usage and troubleshooting docs

**Estimated Complexity:** Small
**Dependencies:** None

---

### Task 6: Create memory usage documentation

**Description:** Document usage patterns, code examples, and best practices for Serena memory operations
**Files:**
- Create `docs/takeoff/serena/MEMORY-USAGE.md`

**Content Sections:**
1. Overview of Serena MCP memory system
2. Code examples for write_memory (all three types)
3. Code examples for read_memory (all three types)
4. Common patterns (update progress, check module state)
5. Best practices (when to write, how often, error handling)
6. Memory structure reference

**Success Criteria:**
- Examples are copy-paste ready
- Covers all three memory types
- Includes error handling examples
- Has clear explanations of when/why to use each memory type
- Links to test scripts for reference

**Estimated Complexity:** Medium
**Dependencies:** Tasks 2, 3, 4 (reference actual test code)

---

### Task 7: Create troubleshooting guide

**Description:** Document common Serena issues, diagnostic steps, and solutions
**Files:**
- Create `docs/takeoff/serena/TROUBLESHOOTING.md`

**Common Issues to Cover:**
1. "Memory not found" error - Cause and fix
2. Serena connection timeout - How to diagnose
3. Memory write failures - Common causes
4. Session state loss - Prevention strategies
5. Memory read returning null - What to check
6. Serena MCP not connected - Setup steps

**Success Criteria:**
- Each issue has clear symptom description
- Each issue has diagnostic commands
- Each issue has solution steps
- Includes links to Serena MCP documentation
- Has "Quick Diagnostics" checklist

**Estimated Complexity:** Small
**Dependencies:** Task 6 (reference usage patterns)

---

### Task 8: Update docs/takeoff/MEMORY.md with validation results

**Description:** Add a new section to existing MEMORY.md documenting P0.2 validation results and linking to new docs
**Files:**
- Modify `docs/takeoff/MEMORY.md`

**New Section to Add:**
```markdown
## Validation Results (P0.2)

**Validated:** 2025-11-22
**Test Scripts:** tests/serena/
**Status:** ✅ All tests passing

### Test Coverage
- ✅ Memory write operations
- ✅ Memory read operations
- ✅ Session persistence (agent restart)
- ✅ All three memory types validated

### Additional Documentation
- Usage Patterns: docs/takeoff/serena/MEMORY-USAGE.md
- Troubleshooting: docs/takeoff/serena/TROUBLESHOOTING.md

### Known Limitations
- Concurrent writes not tested (future enhancement)
- Large data volumes not tested (memories are text-based)
- Memory migration/versioning not implemented
```

**Success Criteria:**
- New section added to MEMORY.md
- Links to new documentation files
- Validation status clearly stated
- Known limitations documented

**Estimated Complexity:** Small
**Dependencies:** Tasks 2-7 (all tests and docs complete)

---

## Dependencies

**External:**
- Serena MCP - Must be installed and connected ✅
- Node.js - For running test scripts ✅

**Internal:**
- **P0.1 Complete** ✅ - Memory documentation exists in docs/takeoff/MEMORY.md
- `.claude/takeoff-system.md` - Defines memory structure ✅
- `serena:/takeoff-progress-tracker` - Already exists from P0.1 ✅

**Enables:**
- **P0.3** - Test Harness (can use Serena for test state)
- **All Phase 1-3 modules** - Rely on validated Serena persistence

---

## Risks

### Risk 1: Serena MCP Connection Instability
**Likelihood:** Low
**Impact:** High (blocks entire module)
**Mitigation:**
- Verify Serena connection before starting tests
- Add retry logic to test scripts (3 attempts)
- Document connection troubleshooting in TROUBLESHOOTING.md

### Risk 2: Test Scripts Can't Access Serena Tools
**Likelihood:** Medium
**Impact:** Medium (need alternative approach)
**Mitigation:**
- Test scripts will use Serena via Claude Code environment, not direct MCP calls
- Alternative: Create wrapper functions that Claude Code can execute
- Fallback: Manual validation steps documented

### Risk 3: Memory Persistence Fails Across Sessions
**Likelihood:** Low
**Impact:** Critical (questions entire autonomous execution strategy)
**Mitigation:**
- If persistence test fails, investigate Serena configuration
- Check for known issues in Serena MCP documentation
- Consider alternative persistence mechanisms (file-based state)

### Risk 4: Node.js Script Execution Issues on Windows
**Likelihood:** Low
**Impact:** Low (can run via Claude Code instead)
**Mitigation:**
- Ensure scripts are cross-platform compatible
- Use Node.js built-in modules (no external dependencies)
- Test on Windows environment (current platform)

---

## Definition of Done

- [x] **All behaviors implemented:**
  - [x] Memory write test script created and functional
  - [x] Memory read test script created and functional
  - [x] Persistence test script created and functional
  - [x] Usage documentation created
  - [x] Troubleshooting guide created
  - [x] MEMORY.md updated with validation results

- [x] **Tests passing:**
  - [x] `node tests/serena/memory-write-test.js` - Writes successfully
  - [x] `node tests/serena/memory-read-test.js` - Reads and validates successfully
  - [x] `node tests/serena/memory-persistence-test.js` - Confirms persistence across restart

- [x] **No console errors:**
  - [x] All scripts execute without JavaScript errors
  - [x] Serena operations complete successfully
  - [x] Clear output for pass/fail status

- [x] **Documentation updated:**
  - [x] docs/takeoff/PROGRESS.md has P0.2 entries
  - [x] docs/takeoff/serena/MEMORY-USAGE.md created
  - [x] docs/takeoff/serena/TROUBLESHOOTING.md created
  - [x] docs/takeoff/MEMORY.md updated with validation section

- [x] **Serena module state:**
  - [x] status: "completed"
  - [x] files_created: [list of 5 new files]
  - [x] files_modified: [docs/takeoff/MEMORY.md]
  - [x] testing: "Manual validation - all scripts passing"
  - [x] plan_path: ".claude/plans/P0.2-plan.md"

---

## Integration Notes

### With Existing System

This module does **not** modify any existing code. It creates:
- New test directory: `tests/serena/`
- New docs directory: `docs/takeoff/serena/`
- Three test scripts (standalone, no dependencies)
- Two documentation files

### With Future Modules

All Phase 1-3 modules will rely on Serena memory for state persistence. This module validates that foundation is solid.

**Memory Usage Patterns for Future Modules:**
1. PLANNER reads current module state from Serena
2. IMPLEMENTER updates module state after each task
3. TESTER records test results in module state
4. DOC marks module complete in Serena

**Validation Provided:**
- Memory write operations work
- Memory read operations work
- Memory survives agent restart (critical for autonomous execution)
- Error handling patterns documented

---

## Testing Strategy

**Test Type:** Manual validation scripts (not Playwright)

**Why Manual Scripts?**
- This is infrastructure validation, not UI testing
- Playwright not needed (no browser interaction)
- Command-line Node.js scripts are sufficient

**Test Execution:**
```bash
# Step 1: Write test data
node tests/serena/memory-write-test.js

# Step 2: Read and validate
node tests/serena/memory-read-test.js

# Step 3: Persistence test (requires agent restart)
node tests/serena/memory-persistence-test.js
# (Follow on-screen instructions to restart agent and run again)
```

**Expected Results:**
- All scripts print "PASS" status
- No errors in console
- Serena memories contain expected data

---

## Task Execution Order

**Sequential Execution:**
1. Task 1 → Task 2 → Task 3 → Task 4 (tests depend on each other)
2. Task 5 → Task 6 → Task 7 (docs depend on directory)
3. Task 8 (final update to MEMORY.md)

**Estimated Timeline:**
- Tasks 1-4: 45 minutes (test script creation)
- Tasks 5-7: 30 minutes (documentation)
- Task 8: 15 minutes (update MEMORY.md)
- **Total: 1.5 hours**

---

## Next Steps After Planning

1. **IMPLEMENTER role** will:
   - Execute tasks 1-8 sequentially
   - Commit after each task
   - Update Serena module state after each task
   - Update docs/takeoff/PROGRESS.md after each task

2. **TESTER role** will:
   - Run all three test scripts
   - Validate outputs match expectations
   - Document test results in docs/takeoff/TEST-RESULTS.md
   - Update Serena with testing summary

3. **DOC role** will:
   - Add Implementation Notes to P0.2-serena-wiring.md
   - Document Known Limitations
   - Add Usage Examples
   - Mark module complete in Serena

---

**Plan Created:** 2025-11-22
**Plan Status:** ✅ Ready for IMPLEMENTER execution
**Next:** IMPLEMENTER role begins Task 1
