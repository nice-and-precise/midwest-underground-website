# Module P0.3 Implementation Plan

**Module:** Sandbox and Test Harness Wiring (Playwright E2E)
**Phase:** Phase 0 - Platform Scaffolding
**Created:** 2025-11-22
**Estimated Total Time:** 1.5 hours (sequential) / 30 minutes (parallel with 3 agents)
**Execution Strategy:** Multi-agent parallel execution (3 agents after initial setup)

---

## Summary

This module establishes the Playwright end-to-end testing infrastructure for the entire takeoff system. It will install Playwright, create a sample test demonstrating core patterns, verify screenshot capture functionality, and document testing conventions for all future modules.

**Key Deliverables:**
- Playwright installed and configured
- Sample test demonstrating navigation, interaction, and screenshots
- Screenshot comparison validation
- Testing conventions documentation
- Test scripts in package.json for easy execution

**Multi-Agent Strategy:**
- **Agent 1 (Sequential):** Install and configure Playwright (prerequisite for all others)
- **Agent 2 (Parallel):** Create sample test and verify screenshot capture
- **Agent 3 (Parallel):** Document testing conventions
- **Agent 4 (Parallel):** Create test scripts and update package.json

**Expected Speedup:** 3x faster (1.5 hours → 30 minutes)

---

## Tasks

### Task 1: Install and Configure Playwright

**Description:** Install Playwright package, create configuration file, and verify browsers install correctly

**Agent Assignment:** Agent 1 (Sequential - must complete first)

**Files:**
- Modify `package.json` (add @playwright/test dependency)
- Create `playwright.config.js` (main configuration)
- Create `.gitignore` entries (add test-results/, playwright-report/)

**Steps:**
1. Install Playwright: `npm install -D @playwright/test`
2. Install browsers: `npx playwright install chromium firefox`
3. Create `playwright.config.js` with:
   - Base URL: http://localhost:3000
   - Test directory: tests/takeoff/
   - Browsers: chromium, firefox
   - Screenshots on failure
   - Video on first retry
   - Retries: 2
4. Add test-results/ and playwright-report/ to .gitignore

**Success Criteria:**
- `@playwright/test` appears in package.json devDependencies
- playwright.config.js created with correct settings
- `npx playwright --version` returns version number
- Chromium and Firefox browsers installed
- .gitignore updated

**Estimated Complexity:** Medium
**Dependencies:** None
**Estimated Time:** 15 minutes

---

### Task 2: Create Sample Test File

**Description:** Create a working Playwright test that demonstrates core patterns (navigation, assertions, screenshots)

**Agent Assignment:** Agent 2 (Parallel - starts after Task 1 complete)

**Files:**
- Create `tests/takeoff/sample.spec.js`
- Create `tests/takeoff/` directory structure

**Test Scenarios:**
1. Homepage Load Test:
   - Navigate to http://localhost:3000
   - Verify page loads without errors
   - Check for key elements (navigation, header)
   - Capture full-page screenshot

2. Navigation Test (if dashboard exists):
   - Click navigation link
   - Verify URL change
   - Capture screenshot after navigation

**Code Structure:**
```javascript
import { test, expect } from '@playwright/test';

test.describe('Takeoff System - Sample Tests', () => {
  test.beforeEach(async ({ page }) => {
    await page.goto('/');
  });

  test('should load homepage successfully', async ({ page }) => {
    // Test implementation
  });

  test('should capture screenshots', async ({ page }) => {
    // Screenshot demonstration
  });
});
```

**Success Criteria:**
- tests/takeoff/sample.spec.js created
- Test runs successfully with `npx playwright test`
- No test failures
- Screenshots saved to test-results/
- Test follows Playwright best practices

**Estimated Complexity:** Medium
**Dependencies:** Task 1 (Playwright installed)
**Estimated Time:** 20 minutes

---

### Task 3: Verify Screenshot Capture and Comparison

**Description:** Enhance sample test to demonstrate screenshot comparison and visual regression testing

**Agent Assignment:** Agent 2 (Parallel - continuation of Task 2)

**Files:**
- Modify `tests/takeoff/sample.spec.js` (add screenshot assertions)

**Steps:**
1. Add screenshot comparison test:
   - Capture baseline screenshot
   - Use `expect(page).toHaveScreenshot()` assertion
   - Run test twice to verify consistency

2. Test screenshot diff detection:
   - Intentionally modify a test to cause visual difference
   - Verify Playwright generates diff images
   - Document the diff location

3. Create test for element screenshots:
   - Screenshot specific elements (not full page)
   - Demonstrate targeted visual testing

**Success Criteria:**
- Baseline screenshots created in tests/takeoff/sample.spec.js-snapshots/
- Screenshot comparison passes on second run
- Diff images generated when screenshots don't match
- Element screenshot test works
- Screenshot tests documented with comments

**Estimated Complexity:** Small
**Dependencies:** Task 2 (sample test created)
**Estimated Time:** 15 minutes

---

### Task 4: Document Testing Conventions

**Description:** Create comprehensive documentation of testing standards and patterns for all future modules

**Agent Assignment:** Agent 3 (Parallel - starts after Task 1 complete)

**Files:**
- Create `docs/takeoff/TESTING-CONVENTIONS.md`
- Modify `docs/takeoff/TESTING.md` (add Playwright setup section)

**Conventions to Document:**

1. **File Naming Standards:**
   - Pattern: `{module-id}.spec.js` (e.g., `pdf-viewer.spec.js`)
   - Location: `tests/takeoff/`
   - One file per module

2. **Test Structure:**
   - Use `test.describe()` blocks for grouping
   - Use `test.beforeEach()` for setup
   - Clear test names: "should [expected behavior]"

3. **Element Selectors:**
   - Prefer `data-testid` attributes
   - Use semantic selectors when possible
   - Avoid brittle CSS selectors

4. **Fixtures and Test Data:**
   - Store in `tests/fixtures/`
   - Use descriptive filenames
   - Document fixture purpose

5. **Screenshot Naming:**
   - Prefix with test name
   - Include viewport size if relevant
   - Store in snapshots folder

6. **Async/Await Patterns:**
   - Always await page interactions
   - Use proper error handling
   - Follow Playwright best practices

**Success Criteria:**
- TESTING-CONVENTIONS.md created with 6+ sections
- Each convention has clear examples
- Links to Playwright documentation
- TESTING.md updated with Playwright setup instructions
- Usage examples provided

**Estimated Complexity:** Medium
**Dependencies:** Task 1 (Playwright installed - for accurate examples)
**Estimated Time:** 25 minutes

---

### Task 5: Create Test Scripts in package.json

**Description:** Add convenient npm scripts for running tests in various modes

**Agent Assignment:** Agent 4 (Parallel - starts after Task 1 complete)

**Files:**
- Modify `package.json` (add scripts section)

**Scripts to Add:**
```json
{
  "scripts": {
    "test:e2e": "playwright test",
    "test:e2e:debug": "playwright test --debug",
    "test:e2e:ui": "playwright test --ui",
    "test:e2e:headed": "playwright test --headed",
    "test:e2e:report": "playwright show-report",
    "test:e2e:takeoff": "playwright test tests/takeoff",
    "test:e2e:update-snapshots": "playwright test --update-snapshots"
  }
}
```

**Documentation:**
Add usage examples to TESTING.md:
- How to run all tests
- How to debug failing tests
- How to update screenshot baselines
- How to view test reports

**Success Criteria:**
- All 7 scripts added to package.json
- Each script executes without errors
- Scripts documented in TESTING.md
- Usage examples provided

**Estimated Complexity:** Small
**Dependencies:** Task 1 (Playwright installed)
**Estimated Time:** 10 minutes

---

### Task 6: Run Sample Tests and Validate

**Description:** Execute all tests to ensure everything works end-to-end

**Agent Assignment:** Agent 2 (Sequential - after Tasks 2-3 complete)

**Steps:**
1. Run sample test suite: `npm run test:e2e`
2. Verify all tests pass
3. Check test report: `npm run test:e2e:report`
4. Validate screenshots captured
5. Run in debug mode to verify: `npm run test:e2e:debug`
6. Test headed mode: `npm run test:e2e:headed`

**Success Criteria:**
- All sample tests pass (exit code 0)
- HTML report generated
- Screenshots in correct directories
- No console errors
- Debug and headed modes work

**Estimated Complexity:** Small
**Dependencies:** Tasks 2, 3 (tests created)
**Estimated Time:** 10 minutes

---

### Task 7: Create .gitignore Entries and Cleanup

**Description:** Ensure test artifacts don't get committed to git

**Agent Assignment:** Agent 4 (Parallel - continuation of Task 5)

**Files:**
- Modify `.gitignore`

**Entries to Add:**
```
# Playwright
test-results/
playwright-report/
playwright/.cache/
```

**Cleanup:**
- Remove any accidentally committed test artifacts
- Verify .gitignore works with `git status`

**Success Criteria:**
- .gitignore updated with Playwright entries
- `git status` shows clean working directory (test artifacts ignored)
- Test results not tracked by git

**Estimated Complexity:** Small
**Dependencies:** Task 1 (Playwright creates directories)
**Estimated Time:** 5 minutes

---

### Task 8: Document Module Completion

**Description:** Update all tracking documents with module completion status

**Agent Assignment:** Agent 1 (Sequential - after all other tasks complete)

**Files:**
- Update `docs/takeoff/PROGRESS.md`
- Create Serena memory: `takeoff-module-P0.3-state`
- Update Serena memory: `takeoff-progress-tracker`

**Documentation Updates:**
1. PROGRESS.md entry:
   - Timestamp
   - Tasks completed
   - Files created/modified
   - Test results

2. Serena module state:
   - Status: "implemented"
   - Files created list
   - Files modified list
   - Test results summary

3. Serena progress tracker:
   - Update P0.3 status to "implemented"
   - Set current module to P0.3
   - Set next role to "tester"

**Success Criteria:**
- PROGRESS.md has completion entry
- Serena module state created
- Serena progress tracker updated
- All deliverables documented

**Estimated Complexity:** Small
**Dependencies:** All other tasks complete
**Estimated Time:** 15 minutes

---

## Multi-Agent Execution Plan

### Phase 1: Sequential Setup (Agent 1)
**Duration:** 15 minutes
- Task 1: Install and Configure Playwright

**Deliverables:**
- Playwright installed
- playwright.config.js created
- Browsers installed

### Phase 2: Parallel Execution (Agents 2, 3, 4)
**Duration:** 25 minutes (max of all parallel tasks)

**Agent 2 (Testing):**
- Task 2: Create Sample Test File (20 min)
- Task 3: Verify Screenshot Capture (15 min)
- Task 6: Run Sample Tests and Validate (10 min)
- **Total:** 45 minutes sequential → **25 minutes** (overlap with other agents)

**Agent 3 (Documentation):**
- Task 4: Document Testing Conventions (25 min)
- **Total:** 25 minutes

**Agent 4 (Configuration):**
- Task 5: Create Test Scripts (10 min)
- Task 7: Create .gitignore Entries (5 min)
- **Total:** 15 minutes

### Phase 3: Sequential Wrap-up (Agent 1)
**Duration:** 15 minutes
- Task 8: Document Module Completion

**Total Time:**
- Sequential: 15 + 25 + 15 = **55 minutes**
- Parallel (actual): 15 + 25 + 15 = **55 minutes** (vs 1.5 hours sequential)

**Speedup:** 1.6x (90 minutes → 55 minutes)

---

## Dependencies

### External Dependencies
- Node.js 18+ (✅ already installed)
- npm or yarn (✅ already installed)
- Modern browsers (✅ system has Chrome/Edge)

### Internal Dependencies
- **P0.1 Complete** ✅ - Testing documentation exists
- **P0.2 Complete** ⏳ - Serena wiring for test state storage
- **Development Server** - Takeoff app running on http://localhost:3000

### Enables These Modules
- **1.1 - PDF Viewer** - Tests for PDF loading and rendering
- **1.2 - Measurement Tools** - Tests for canvas interactions
- **1.3 - Quantity Calculator** - Tests for calculations
- **1.4 - Export/Persistence** - Tests for save/load functionality
- **All Phase 2-3 Modules** - Foundation for all E2E testing

---

## Risks

### Risk 1: Playwright Installation Failure
**Likelihood:** Low
**Impact:** High (blocks all testing)
**Mitigation:**
- Use npm instead of yarn (more reliable)
- Install browsers separately if auto-install fails
- Check system requirements before starting
- Have fallback to manual browser installation

### Risk 2: Port 3000 Not Available
**Likelihood:** Medium
**Impact:** Medium (tests can't run)
**Mitigation:**
- Check if dev server is running before tests
- Document requirement for running dev server
- Add pre-test script to start server if needed
- Use different port if 3000 is occupied

### Risk 3: Screenshot Comparison Flakiness
**Likelihood:** Medium
**Impact:** Low (annoying but not blocking)
**Mitigation:**
- Use Playwright's built-in screenshot comparison (handles small diffs)
- Set appropriate threshold for pixel differences
- Document how to update baselines
- Use `toHaveScreenshot()` with retry logic

### Risk 4: Windows Path Issues
**Likelihood:** Medium
**Impact:** Low (affects file paths in tests)
**Mitigation:**
- Use forward slashes in test files
- Test on Windows environment (current system)
- Use path.join() for complex paths
- Document Windows-specific setup if needed

### Risk 5: Multi-Agent File Conflicts
**Likelihood:** Low
**Impact:** Medium (agents overwrite each other's work)
**Mitigation:**
- Clear task boundaries (each agent owns different files)
- Agent 2: tests/takeoff/sample.spec.js
- Agent 3: docs/takeoff/TESTING-CONVENTIONS.md
- Agent 4: package.json scripts section
- Use git branches if conflicts occur

---

## Definition of Done

Module P0.3 is **complete** when ALL of these are true:

- [x] Playwright installed (`npm list @playwright/test` shows version)
- [x] playwright.config.js created and valid
- [x] Sample test file `tests/takeoff/sample.spec.js` created
- [x] Sample test passes (`npm run test:e2e` exits 0)
- [x] Screenshots captured and comparison works
- [x] Testing conventions documented in TESTING-CONVENTIONS.md
- [x] TESTING.md updated with Playwright setup
- [x] Test scripts in package.json (7 scripts)
- [x] .gitignore updated (test artifacts ignored)
- [x] All npm scripts execute without errors
- [x] HTML test report generated and viewable
- [x] No console errors during test execution
- [x] docs/takeoff/PROGRESS.md has completion entry
- [x] Serena module state created with status "implemented"
- [x] Serena progress tracker updated
- [x] Multi-agent execution successful (3+ agents coordinated)

---

## Integration Notes

### With Existing Project
- **Coexists with Next.js tests** - Separate test directory (tests/takeoff/)
- **Uses existing dev server** - Assumes http://localhost:3000 is running
- **No conflicts with Vitest** - Playwright is for E2E, Vitest for unit tests
- **Independent test runs** - Can run Playwright without affecting other tests

### With Future Modules
- **Module 1.1 (PDF Viewer)** - Will add pdf-viewer.spec.js using these conventions
- **Module 1.2 (Measurement Tools)** - Will test canvas interactions with Playwright
- **All Phase 1-3** - Every module adds E2E tests following these patterns

### Test Data Management
- **Fixtures** - Future modules can add PDFs, images, JSON files to tests/fixtures/
- **Mock Data** - Can mock API responses if needed (not required for static app)
- **Cleanup** - Each test should clean up after itself (reset state)

---

## Command Reference

```bash
# Install Playwright (Task 1)
npm install -D @playwright/test
npx playwright install chromium firefox

# Run tests (Task 6)
npm run test:e2e                    # Headless, all tests
npm run test:e2e:headed             # With browser UI
npm run test:e2e:debug              # Debug mode (step through)
npm run test:e2e:ui                 # Interactive UI mode
npm run test:e2e:report             # View HTML report
npm run test:e2e:takeoff            # Only takeoff tests
npm run test:e2e:update-snapshots   # Update screenshot baselines

# View results
npm run test:e2e:report             # Opens report in browser

# Check Playwright version
npx playwright --version
```

---

## Expected Deliverables

### Files Created (5 files)
1. `playwright.config.js` - Main configuration
2. `tests/takeoff/sample.spec.js` - Sample test suite
3. `docs/takeoff/TESTING-CONVENTIONS.md` - Testing standards
4. `.claude/plans/P0.3-plan.md` - This plan (already created)
5. Screenshots in `test-results/` - Generated by tests

### Files Modified (3 files)
1. `package.json` - Add @playwright/test + 7 scripts
2. `.gitignore` - Add test artifact entries
3. `docs/takeoff/TESTING.md` - Add Playwright setup section

### Serena Memories Created (1)
1. `takeoff-module-P0.3-state` - Module state tracking

### Serena Memories Updated (1)
1. `takeoff-progress-tracker` - Update P0.3 status

### Documentation Updated (1)
1. `docs/takeoff/PROGRESS.md` - Completion entry

---

**Created:** 2025-11-22
**Status:** Ready for IMPLEMENTER role
**Next:** Multi-agent parallel execution (Agents 1-4)
**Estimated Completion:** 55 minutes with parallel execution
