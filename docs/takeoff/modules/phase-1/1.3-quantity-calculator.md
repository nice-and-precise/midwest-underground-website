# Module 1.3: Quantity Calculator

## Overview

This module provides real-time quantity aggregation and display by listening to measurement events from Module 1.2. It maintains running totals by category (HDD, Fiber, Trench, Excavation, Pits, etc.) and presents them in a live-updating panel within the takeoff interface.

The quantity calculator acts as the single source of truth for total quantities, which will be used by Module 1.4 for exports and by Phase 2's estimate builder to calculate costs.

## Outcome

A live quantity summary panel that:
- Displays running totals by measurement category
- Updates in real-time as measurements are added/modified/deleted
- Shows quantities in appropriate units (linear feet, square feet, counts)
- Supports multiple pages (aggregates across entire document)
- Provides visual breakdown (charts, progress indicators)
- Allows filtering and grouping by category
- Validates quantities before export

## Key Behaviors

### Event-Driven Updates
- Listen for `measurement:changed` events from measurement-tools.js
- Update totals immediately when measurements are created, modified, or deleted
- Recalculate totals when scale calibration changes
- Handle page changes (maintain totals across all pages)
- Debounce rapid updates (e.g., during dragging) for performance

### Quantity Aggregation
- Group measurements by category (HDD, Fiber, Trench, Excavation, Pits, Other)
- Sum linear measurements (total feet/meters of bore, fiber, trench)
- Sum area measurements (total square feet/meters of excavation, paving)
- Count markers (total number of pits, splices, poles)
- Support mixed units (convert meters to feet, or keep separate)
- Maintain subtotals per page and grand totals across document

### Live UI Updates
- Update quantity panel without page refresh
- Highlight changed quantities (flash animation on update)
- Show percentage breakdowns (e.g., "HDD: 45% of total linear footage")
- Display unit conversions (feet to miles, sqft to acres)
- Color-code categories to match measurement overlay colors

### Data Validation
- Warn if measurements exist without scale calibration
- Flag negative quantities (should never happen, indicates error)
- Detect duplicate measurements (same points, same category)
- Validate unit consistency per category
- Check for orphaned measurements (page deleted, measurement remains)

### Quantity Export Interface
- Provide data in structured format for Module 1.4 (export)
- Support query by category (e.g., "get all HDD quantities")
- Support query by page (e.g., "get quantities from page 3")
- Return metadata (timestamp, scale used, page count)

## Allowed Files

**Create:**
- `dashboard/js/quantity-calculator.js` - Quantity aggregation and state management

**Modify:**
- `dashboard/js/measurement-tools.js` - Add event emission for measurement changes
- `dashboard/takeoff.html` - Add quantity summary panel
- `dashboard/css/takeoff.css` - Style quantity panel and visualizations

## Dependencies

**External Libraries:**
- Chart.js (already in use) - for visual quantity breakdowns
  - Pie chart: category distribution
  - Bar chart: quantities by page

**Internal Dependencies:**
- Module 1.2 (Measurement Tools) - requires measurement events
  - Needs `measurement:changed` event with measurement data
  - Needs access to scale data for unit conversions
- Module 1.1 (PDF Viewer) - requires page change events
  - Needs `page:changed` event to maintain per-page totals

## Skills Needed

- Event-Driven Architecture
  - Event listener registration
  - Event handler implementation
  - Handling asynchronous updates
- State Management
  - Maintaining aggregate state
  - State updates and synchronization
  - State validation and error handling
- Data Aggregation
  - Grouping and summing operations
  - Handling multiple data types (linear, area, count)
  - Unit conversion calculations
- Real-Time UI Updates
  - DOM manipulation for live updates
  - CSS animations for visual feedback
  - Debouncing for performance
- Chart.js Integration
  - Creating/updating pie and bar charts
  - Dynamic data binding
  - Responsive chart sizing

## Constraints

### Technology Constraints
- Use only static HTML/JS/CSS (no framework)
- Chart.js already loaded via CDN (no new dependencies)
- All quantity data stored in browser memory (not persisted until Module 1.4)
- Must not block UI thread during aggregation

### Performance Constraints
- Debounce updates during rapid changes (e.g., dragging measurement)
- Cache aggregated totals (don't recalculate from scratch every time)
- Lazy-load charts (don't render until panel expanded)
- Limit update frequency to 60 FPS (avoid excessive re-renders)

### UX Constraints
- Updates should feel instant (< 50ms perceived latency)
- Show loading indicator only if calculation takes > 200ms
- Maintain scroll position in quantity panel during updates
- Provide visual feedback for every change (flash, animation)

### Data Integrity Constraints
- Totals must exactly match sum of individual measurements
- Unit conversions must be accurate (use standard conversion factors)
- Handle floating-point precision issues (round to 2 decimal places)
- Validate data before displaying (no NaN, Infinity, negative values)

## Data Structures

### Quantity State Schema

```javascript
// Main state object maintained by quantity-calculator.js
const quantityState = {
  categories: {
    HDD: {
      type: 'linear',
      unit: 'feet',
      total: 1250.5,                    // Grand total across all pages
      byPage: {                          // Per-page breakdown
        1: 450.5,
        2: 400.0,
        3: 400.0,
      },
      measurements: [                    // Reference to individual measurements
        'uuid-1', 'uuid-2', 'uuid-3',
      ],
      color: '#003B5C',                  // Display color
    },
    Fiber: {
      type: 'linear',
      unit: 'feet',
      total: 1250.5,
      byPage: { 1: 450.5, 2: 400.0, 3: 400.0 },
      measurements: ['uuid-4', 'uuid-5'],
      color: '#FF6B35',
    },
    Trench: {
      type: 'linear',
      unit: 'feet',
      total: 500.0,
      byPage: { 2: 300.0, 3: 200.0 },
      measurements: ['uuid-6'],
      color: '#8B4513',
    },
    Excavation: {
      type: 'area',
      unit: 'sqft',
      total: 2500.0,
      byPage: { 1: 1200.0, 3: 1300.0 },
      measurements: ['uuid-7', 'uuid-8'],
      color: '#FFD700',
    },
    Pits: {
      type: 'count',
      unit: 'count',
      total: 12,
      byPage: { 1: 4, 2: 3, 3: 5 },
      measurements: ['uuid-9', 'uuid-10', 'uuid-11', 'uuid-12'],
      color: '#DC143C',
    },
  },
  totals: {
    linear: 3000.0,                      // Sum of all linear categories
    area: 2500.0,                        // Sum of all area categories
    count: 12,                           // Sum of all count categories
  },
  lastUpdated: '2025-11-22T11:30:00Z',
  validationErrors: [],                  // Array of validation warnings
};
```

### Quantity Summary DTO

```javascript
// Data structure returned by getQuantitySummary() for exports
const quantitySummary = {
  projectName: 'Main Street Fiber Install',
  documentPages: 15,
  categories: [
    {
      name: 'HDD',
      type: 'linear',
      unit: 'feet',
      total: 1250.5,
      unitPrice: null,                   // Filled in by Phase 2 estimate builder
      totalCost: null,
    },
    {
      name: 'Fiber',
      type: 'linear',
      unit: 'feet',
      total: 1250.5,
      unitPrice: null,
      totalCost: null,
    },
    {
      name: 'Excavation',
      type: 'area',
      unit: 'sqft',
      total: 2500.0,
      unitPrice: null,
      totalCost: null,
    },
    {
      name: 'Pits',
      type: 'count',
      unit: 'count',
      total: 12,
      unitPrice: null,
      totalCost: null,
    },
  ],
  totals: {
    linearFeet: 3000.0,
    squareFeet: 2500.0,
    count: 12,
  },
  generatedAt: '2025-11-22T11:30:00Z',
};
```

### Update Event Schema

```javascript
// Event emitted when quantities change (for Module 1.4 to listen)
const quantityUpdateEvent = new CustomEvent('quantity:updated', {
  detail: {
    category: 'HDD',
    previousTotal: 1200.0,
    newTotal: 1250.5,
    delta: 50.5,
    timestamp: '2025-11-22T11:30:00Z',
  },
});
```

## Implementation Notes

**To be added after implementation:**
- Aggregation algorithm performance benchmarks
- Chart.js integration approach
- Unit conversion accuracy tests
- Validation error handling approach
- Event listener cleanup strategy

## Known Limitations

**To be added after implementation:**
- Maximum measurements supported before performance degrades
- Floating-point precision issues encountered
- Chart rendering performance with many categories
- Browser compatibility issues (if any)
- Edge cases in validation logic

---

**Module Status:** Not Started
**Phase:** Phase 1 - Takeoff Core
**Dependencies:** Module 1.2 (Measurement Tools), Module 1.1 (PDF Viewer)
**Next Module:** 1.4 - Export & Persistence (will save/load entire takeoff state)
