<!-- TOC -->

## Table of Contents

- [Overview](#overview)
- [Outcome](#outcome)
- [Key Behaviors](#key-behaviors)
  - [State Serialization](#state-serialization)
  - [Auto-Save](#auto-save)
  - [Manual Save](#manual-save)
  - [Load Takeoff](#load-takeoff)
  - [CSV Export](#csv-export)
  - [JSON Export](#json-export)
  - [PDF Summary Export](#pdf-summary-export)
  - [Takeoff Management](#takeoff-management)
  - [Data Migration](#data-migration)
- [Allowed Files](#allowed-files)
- [Dependencies](#dependencies)
- [Skills Needed](#skills-needed)
- [Constraints](#constraints)
  - [Technology Constraints](#technology-constraints)
  - [Storage Constraints](#storage-constraints)
  - [Export Constraints](#export-constraints)
  - [Data Integrity Constraints](#data-integrity-constraints)
- [Data Structures](#data-structures)
  - [Takeoff Data Schema (v1.0)](#takeoff-data-schema-v10)
  - [CSV Export Format](#csv-export-format)
  - [localStorage Keys](#localstorage-keys)
- [Implementation Notes](#implementation-notes)
- [Known Limitations](#known-limitations)

<!-- /TOC -->

# Module 1.4: Export & Persistence

## Overview

This module completes Phase 1 by adding the ability to save and load takeoffs, export quantity data to multiple formats, and persist takeoff state across browser sessions. It acts as the data layer for the entire takeoff system, serializing all state from Modules 1.1, 1.2, and 1.3 into a structured JSON format.

This module also creates the foundation for Phase 2's estimating features by providing clean, structured quantity data that can be mapped to cost items.

## Outcome

A complete data persistence and export system that enables:
- Save takeoff to browser localStorage (auto-save and manual save)
- Load previously saved takeoffs
- Export quantities to CSV (for spreadsheet import)
- Export full takeoff to JSON (for programmatic use)
- Export summary report to PDF (using jsPDF)
- Manage multiple saved takeoffs (list, rename, delete)
- Handle browser quota limits gracefully
- Provide data migration path for future schema changes

## Key Behaviors

### State Serialization
- Collect state from pdf-viewer.js (PDF file, zoom, page)
- Collect state from measurement-tools.js (all measurements, scale data)
- Collect state from quantity-calculator.js (aggregated quantities)
- Serialize to JSON with schema version
- Compress large payloads (optional, if storage limits hit)
- Validate serialized data before saving

### Auto-Save
- Debounce auto-save (trigger 2 seconds after last change)
- Save to localStorage with timestamped key
- Limit auto-save history (keep last 5 auto-saves)
- Show "Saved" indicator in UI after successful save
- Handle save errors (quota exceeded, private browsing mode)

### Manual Save
- Prompt user for takeoff name
- Save to localStorage with user-defined key
- Associate with project metadata (project ID, client name)
- Overwrite confirmation if name exists
- Create new version if user chooses

### Load Takeoff
- List all saved takeoffs (name, date, page count, total quantities)
- Preview takeoff before loading (thumbnail, summary)
- Load takeoff and restore all state (PDF, measurements, scale, zoom)
- Handle missing PDF file (PDF not stored, only file name)
- Warn if loading will discard unsaved changes

### CSV Export
- Export quantity summary in CSV format
- Columns: Category, Type, Quantity, Unit, Notes
- One row per category
- Include totals row at bottom
- Trigger browser download with filename: `{projectName}-quantities.csv`

### JSON Export
- Export full takeoff data structure
- Include all measurements with coordinates
- Include scale data, page assignments
- Include metadata (project, date, version)
- Trigger browser download with filename: `{projectName}-takeoff.json`
- Validate JSON before export (ensure it can be re-imported)

### PDF Summary Export
- Use jsPDF to generate professional summary report
- Include: project name, date, page count
- Table of quantities by category
- Optional: thumbnail images of key pages
- Optional: company branding (logo, colors)
- Trigger browser download with filename: `{projectName}-summary.pdf`

### Takeoff Management
- List all saved takeoffs in a management panel
- Sort by date, name, or total quantity
- Search/filter takeoffs by name or project
- Rename takeoff
- Delete takeoff (with confirmation)
- Duplicate takeoff (create copy)
- Export multiple takeoffs to ZIP (future enhancement)

### Data Migration
- Store schema version with each saved takeoff
- Detect old schema versions on load
- Migrate data to current schema automatically
- Log migration warnings/errors
- Provide rollback option if migration fails

## Allowed Files

**Create:**
- `dashboard/js/takeoff-export.js` - Save/load/export logic
- `dashboard/api/data/takeoffs.json` - Example takeoff data structure (for reference)

**Modify:**
- `dashboard/takeoff.html` - Add save/load/export buttons and management UI
- `dashboard/js/pdf-viewer.js` - Add state export methods, load handlers
- `dashboard/js/measurement-tools.js` - Add serialization/deserialization methods
- `dashboard/js/quantity-calculator.js` - Add export data formatting methods
- `dashboard/css/takeoff.css` - Style save/load/export UI elements

## Dependencies

**External Libraries:**
- jsPDF (v2.5.1 or later) via CDN - for PDF summary generation
  - `https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js`
- jsPDF AutoTable plugin (v3.5.31 or later) - for table formatting in PDFs
  - `https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js`

**Internal Dependencies:**
- Module 1.1 (PDF Viewer) - requires viewer state for serialization
- Module 1.2 (Measurement Tools) - requires measurement data and scale data
- Module 1.3 (Quantity Calculator) - requires aggregated quantity data

## Skills Needed

- localStorage API
  - setItem/getItem for save/load
  - Key enumeration for listing saved takeoffs
  - Quota management and error handling
  - Private browsing mode detection
- JSON Serialization
  - JSON.stringify with custom replacers
  - JSON.parse with custom revivers
  - Handling circular references
  - Data validation and schema versioning
- File Downloads
  - Blob creation for downloads
  - URL.createObjectURL for download links
  - CSV formatting (escaping, quoting)
- jsPDF API
  - Document creation and formatting
  - Table generation with AutoTable
  - Text styling and layout
  - Multi-page documents
- State Management
  - Coordinating state across multiple modules
  - Deep cloning objects
  - State validation before save/load
- Data Migration
  - Schema versioning strategies
  - Forward/backward compatibility
  - Migration scripts

## Constraints

### Technology Constraints
- Use only static HTML/JS/CSS (no framework)
- localStorage is primary storage (5-10MB limit)
- PDF files NOT stored (too large) - only file name and path stored
- All libraries loaded from CDN (no npm/build process)

### Storage Constraints
- localStorage limit: 5-10MB per origin (browser-dependent)
- Store only essential data (measurements, scale, metadata)
- Compress or limit auto-save history to manage quota
- Warn user when approaching quota limit
- Provide "clear old saves" option

### Export Constraints
- CSV must be compatible with Excel, Google Sheets
- JSON must be valid and re-importable
- PDF should be professional quality (for client sharing)
- All exports triggered as downloads (no email/upload)

### Data Integrity Constraints
- Validate all data before saving
- Detect and prevent data corruption
- Handle version mismatches gracefully
- Maintain referential integrity (measurements → categories → quantities)
- Log errors but don't crash on invalid data

## Data Structures

### Takeoff Data Schema (v1.0)

```javascript
// Complete takeoff data structure saved to localStorage
const takeoffData = {
  version: '1.0',                        // Schema version for migration
  metadata: {
    id: 'uuid-v4',                       // Unique takeoff ID
    name: 'Main Street Fiber Install',   // User-defined name
    projectId: 'project-123',            // Link to Next.js project (optional)
    clientName: 'City of Willmar',       // Client name (optional)
    createdAt: '2025-11-22T10:00:00Z',
    updatedAt: '2025-11-22T11:30:00Z',
    createdBy: 'user@example.com',       // User email (if authenticated)
  },
  pdfInfo: {
    fileName: 'main-street-plans.pdf',   // Original file name
    fileSize: 5242880,                   // File size in bytes (5MB)
    totalPages: 15,                      // Total page count
    filePath: null,                      // Not stored (too large)
    uploadedAt: '2025-11-22T10:00:00Z',
  },
  viewerState: {
    currentPage: 3,                      // Last viewed page
    zoom: 1.5,                           // Last zoom level
    panPosition: { x: 0, y: 0 },         // Last pan position
  },
  scaleData: [                           // Scale calibration per page
    {
      pageNumber: 1,
      pixelDistance: 100,
      realWorldDistance: 50,
      units: 'feet',
      ratio: 0.5,
      calibrationPoints: [[x1, y1], [x2, y2]],
      createdAt: '2025-11-22T10:15:00Z',
    },
    {
      pageNumber: 2,
      pixelDistance: 120,
      realWorldDistance: 60,
      units: 'feet',
      ratio: 0.5,
      calibrationPoints: [[x1, y1], [x2, y2]],
      createdAt: '2025-11-22T10:20:00Z',
    },
  ],
  measurements: [                        // All measurements from all pages
    {
      id: 'uuid-1',
      type: 'linear',
      category: 'HDD',
      label: 'Bore Path 1',
      pageNumber: 1,
      points: [[x1, y1], [x2, y2], [x3, y3]],
      value: 450.5,
      units: 'feet',
      color: '#003B5C',
      notes: 'Main bore from entry to exit pit',
      createdAt: '2025-11-22T10:30:00Z',
      updatedAt: '2025-11-22T10:35:00Z',
    },
    {
      id: 'uuid-2',
      type: 'area',
      category: 'Excavation',
      label: 'Entry Pit Area',
      pageNumber: 1,
      vertices: [[x1, y1], [x2, y2], [x3, y3], [x4, y4]],
      value: 120.0,
      units: 'sqft',
      color: '#FFD700',
      notes: '10x12 entry pit',
      createdAt: '2025-11-22T10:40:00Z',
    },
    {
      id: 'uuid-3',
      type: 'count',
      category: 'Pits',
      label: 'Entry Pit #1',
      pageNumber: 1,
      position: [x, y],
      value: 1,
      icon: 'pit',
      number: 1,
      color: '#DC143C',
      createdAt: '2025-11-22T10:45:00Z',
    },
  ],
  quantities: {                          // Aggregated quantities (from Module 1.3)
    categories: {
      HDD: {
        type: 'linear',
        unit: 'feet',
        total: 1250.5,
        byPage: { 1: 450.5, 2: 400.0, 3: 400.0 },
        measurementIds: ['uuid-1', 'uuid-4', 'uuid-7'],
      },
      Fiber: {
        type: 'linear',
        unit: 'feet',
        total: 1250.5,
        byPage: { 1: 450.5, 2: 400.0, 3: 400.0 },
        measurementIds: ['uuid-10', 'uuid-11'],
      },
      Excavation: {
        type: 'area',
        unit: 'sqft',
        total: 2500.0,
        byPage: { 1: 1200.0, 3: 1300.0 },
        measurementIds: ['uuid-2', 'uuid-8'],
      },
      Pits: {
        type: 'count',
        unit: 'count',
        total: 12,
        byPage: { 1: 4, 2: 3, 3: 5 },
        measurementIds: ['uuid-3', 'uuid-5', 'uuid-6'],
      },
    },
    totals: {
      linear: 3000.0,
      area: 2500.0,
      count: 12,
    },
  },
};
```

### CSV Export Format

```csv
Category,Type,Quantity,Unit,Notes
HDD,Linear,1250.5,feet,Bore paths
Fiber,Linear,1250.5,feet,Fiber conduit runs
Trench,Linear,500.0,feet,Open trenching
Excavation,Area,2500.0,sqft,Entry/exit pits and bore zones
Pits,Count,12,count,Entry and exit pits
TOTAL LINEAR,,3000.0,feet,
TOTAL AREA,,2500.0,sqft,
TOTAL COUNT,,12,count,
```

### localStorage Keys

```javascript
// Key structure for saved takeoffs
const STORAGE_KEYS = {
  AUTOSAVE_PREFIX: 'takeoff_autosave_',     // takeoff_autosave_{timestamp}
  MANUAL_SAVE_PREFIX: 'takeoff_save_',      // takeoff_save_{name}
  SETTINGS: 'takeoff_settings',             // User preferences
  LAST_OPENED: 'takeoff_last_opened',       // ID of last opened takeoff
};

// Example keys in localStorage:
// - takeoff_autosave_1732284000000
// - takeoff_save_main_street_fiber
// - takeoff_settings
// - takeoff_last_opened
```

## Implementation Notes

**To be added after implementation:**
- localStorage quota handling approach
- jsPDF template design choices
- CSV formatting edge cases handled
- Data migration strategy implemented
- Performance benchmarks for large takeoffs

## Known Limitations

**To be added after implementation:**
- Maximum takeoff size before hitting quota
- PDF file handling (user must re-upload PDF when loading saved takeoff)
- Browser compatibility for localStorage and downloads
- jsPDF limitations (page size, table complexity)
- Known data migration issues

---

**Module Status:** Not Started
**Phase:** Phase 1 - Takeoff Core
**Dependencies:** Module 1.1 (PDF Viewer), Module 1.2 (Measurement Tools), Module 1.3 (Quantity Calculator)
**Next Phase:** Phase 2 - Estimating Engine (will use takeoff data to build cost estimates)
