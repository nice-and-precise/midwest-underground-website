# Module 1.2: Measurement Tools

## Overview

This module adds interactive measurement capabilities to the PDF viewer by overlaying a Fabric.js canvas on top of the PDF rendering canvas. Users can draw measurements directly on construction plans using tools for linear measurements, area measurements, and count markers.

The module implements scale calibration (critical for accurate measurements) and provides real-time feedback as users draw. All measurement data is structured to support quantity aggregation in Module 1.3.

## Outcome

A fully functional measurement toolset integrated into the existing PDF viewer that enables:
- Scale calibration (set real-world distance for pixel measurements)
- Linear measurement tool (measure HDD bore paths, fiber runs, trenching)
- Area measurement tool (measure excavation areas, paving areas)
- Count tool (mark entry/exit pits, splice locations, equipment)
- Measurement editing (move, resize, delete measurements)
- Measurement labeling (assign categories and custom labels)
- Real-time measurement display (show length/area as user draws)

## Key Behaviors

### Fabric.js Canvas Overlay
- Create transparent Fabric.js canvas positioned over PDF canvas
- Maintain sync between PDF zoom/pan and Fabric overlay
- Ensure Fabric canvas matches PDF canvas dimensions exactly
- Update Fabric viewport when PDF zoom or page changes
- Clear Fabric canvas when changing PDF pages (with confirmation if unsaved)

### Scale Calibration
- Present scale tool as first required step
- User clicks two points on a known distance (e.g., scale bar on plan)
- User enters real-world distance and units (feet, meters, inches)
- Calculate pixels-per-unit ratio for current page and zoom level
- Store scale data per page (each page may have different scale)
- Recalculate measurements when zoom changes
- Display current scale in UI (e.g., "1 inch = 50 feet")
- Allow re-calibration at any time

### Linear Measurement Tool
- Click-to-add-point polyline drawing
- Double-click or Enter key to finish line
- Display running total length as user adds points
- Snap to measurement endpoints (within 10px radius)
- Show dimension labels along line segments
- Assign measurement to category (HDD, Fiber, Trench, Other)
- Support curved paths (Bezier curves) for realistic bore paths
- Calculate total length accounting for all segments

### Area Measurement Tool
- Click-to-add-vertex polygon drawing
- Close polygon by clicking first point or pressing Enter
- Display running perimeter and area as user draws
- Support irregular polygons (not just rectangles)
- Show area in square feet/meters
- Assign to category (Excavation, Paving, Bore Zone, Other)
- Fill with semi-transparent color (different per category)

### Count Tool
- Click-to-place marker (icon or numbered circle)
- Assign to category (Pits, Splices, Poles, Equipment, Other)
- Display count number on marker (auto-increment per category)
- Support custom icons (can add icon library later)
- Allow markers to be dragged after placement

### Measurement Editing
- Click to select measurement (highlight with selection handles)
- Drag handles to resize/reshape
- Drag entire measurement to move
- Delete key or trash button to remove
- Undo/redo support (Ctrl+Z / Ctrl+Shift+Z)
- Copy/paste measurements (Ctrl+C / Ctrl+V)

### Measurement Properties
- Double-click measurement to open properties panel
- Edit label, category, notes
- Change color/style
- View calculated values (length, area, count)
- Timestamp of creation/modification

### Event Emission
- Emit events when measurements are created/modified/deleted
- Events consumed by Module 1.3 for quantity aggregation
- Include measurement data (type, category, value, units)

## Allowed Files

**Create:**
- `dashboard/js/measurement-tools.js` - Fabric.js integration and measurement logic

**Modify:**
- `dashboard/js/pdf-viewer.js` - Add integration hooks for Fabric overlay sync
- `dashboard/takeoff.html` - Add measurement tool UI (toolbar, properties panel)
- `dashboard/css/takeoff.css` - Add styles for measurement tools and overlays

## Dependencies

**External Libraries:**
- Fabric.js (v5.3.0 or later) via CDN
  - `https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js`

**Internal Dependencies:**
- Module 1.1 (PDF Viewer) - requires PDF canvas to overlay on
  - Needs access to `viewerState.zoom` for scale calculations
  - Needs access to `viewerState.canvas` for overlay positioning
  - Needs page change events to clear/save measurements

## Skills Needed

- Fabric.js Canvas API
  - Canvas creation and overlay positioning
  - Object creation (lines, polygons, circles, paths)
  - Event handling (mouse, keyboard)
  - Object selection and manipulation
  - Canvas serialization/deserialization
- Geometry Calculations
  - Distance calculation (Pythagorean theorem)
  - Polyline length calculation (sum of segments)
  - Polygon area calculation (shoelace formula)
  - Bezier curve length approximation
- Scale Conversion
  - Pixels to real-world units conversion
  - Handling zoom level changes
  - Per-page scale storage
- Event-Driven Architecture
  - CustomEvent creation and dispatch
  - Event listener patterns
  - Decoupled module communication
- UI/UX Design
  - Tool selection patterns (radio buttons, toolbar)
  - Real-time visual feedback
  - Hover states and selection indicators

## Constraints

### Technology Constraints
- Use only static HTML/JS/CSS (no framework)
- Fabric.js must be loaded from CDN (no npm/build process)
- All measurement data stored in browser memory (not persisted until Module 1.4)
- Canvas overlay must not interfere with PDF viewer controls

### Performance Constraints
- Limit measurements per page (recommend 500 max for performance)
- Debounce scale recalculation on zoom (avoid recalculating on every zoom tick)
- Use Fabric.js object caching for complex measurements
- Clear measurements from previous pages (don't keep all pages in memory)

### UX Constraints
- Tool selection should be obvious (highlighted active tool)
- Provide visual feedback during drawing (preview line, area outline)
- Confirm before clearing unsaved measurements
- Show measurement values in real-time (don't make user wait)
- Support both mouse and touch input (for tablet use)

### Accuracy Constraints
- Scale calibration must be accurate to within 1% (critical for estimates)
- Store scale as exact ratio (not rounded percentage)
- Recalculate measurements when scale changes
- Warn user if measurements exist without scale calibration

## Data Structures

### Measurement Object Schema

```javascript
// Base measurement structure (extended by type)
const measurement = {
  id: 'uuid-v4',                    // Unique identifier
  type: 'linear' | 'area' | 'count', // Measurement type
  category: 'HDD' | 'Fiber' | 'Trench' | 'Excavation' | 'Pits' | 'Other',
  label: 'Bore Path 1',             // User-defined label
  pageNumber: 3,                    // PDF page where measurement exists
  fabricObject: fabricObj,          // Fabric.js object reference
  value: 450.5,                     // Calculated value (length, area, or count)
  units: 'feet' | 'meters' | 'sqft' | 'sqm', // Measurement units
  color: '#FF6B35',                 // Display color
  notes: 'Optional notes',          // User notes
  createdAt: '2025-11-22T10:00:00Z',
  updatedAt: '2025-11-22T11:30:00Z',
};

// Linear measurement specific data
const linearMeasurement = {
  ...measurement,
  type: 'linear',
  points: [[x1, y1], [x2, y2], [x3, y3]], // Polyline vertices
  segments: [                        // Pre-calculated segment data
    { length: 150.5, angle: 45 },
    { length: 300.0, angle: 90 },
  ],
  totalLength: 450.5,                // Sum of all segments
  isCurved: false,                   // Whether to render as Bezier curve
};

// Area measurement specific data
const areaMeasurement = {
  ...measurement,
  type: 'area',
  vertices: [[x1, y1], [x2, y2], [x3, y3], [x4, y4]], // Polygon vertices
  perimeter: 500.0,                  // Total perimeter length
  area: 12500.0,                     // Calculated area
};

// Count measurement specific data
const countMeasurement = {
  ...measurement,
  type: 'count',
  position: [x, y],                  // Marker center point
  icon: 'pit' | 'splice' | 'pole' | 'marker', // Icon type
  number: 3,                         // Count number (e.g., "Pit #3")
};
```

### Scale Calibration Schema

```javascript
// Stored per page in viewerState
const scaleData = {
  pageNumber: 3,
  pixelDistance: 100,           // Distance in pixels between calibration points
  realWorldDistance: 50,        // Corresponding real-world distance
  units: 'feet' | 'meters',     // Real-world units
  ratio: 0.5,                   // Pixels per unit (pixelDistance / realWorldDistance)
  calibrationPoints: [          // The two points used for calibration (for visualization)
    [x1, y1],
    [x2, y2],
  ],
  createdAt: '2025-11-22T10:00:00Z',
};
```

### Measurement Events

```javascript
// CustomEvent dispatched when measurements change
const measurementEvent = new CustomEvent('measurement:changed', {
  detail: {
    action: 'created' | 'updated' | 'deleted',
    measurement: measurementObject,
    timestamp: '2025-11-22T10:00:00Z',
  },
});
```

## Implementation Notes

**To be added after implementation:**
- Fabric.js version used
- Geometry calculation accuracy tests
- Performance with 100+ measurements
- Browser touch input support results
- Integration approach with pdf-viewer.js

## Known Limitations

**To be added after implementation:**
- Maximum measurements per page tested
- Scale accuracy validation results
- Known touch input issues
- Curved line rendering limitations
- Fabric.js browser compatibility issues

---

**Module Status:** Not Started
**Phase:** Phase 1 - Takeoff Core
**Dependencies:** Module 1.1 (PDF Viewer)
**Next Module:** 1.3 - Quantity Calculator (will aggregate measurements by category)
