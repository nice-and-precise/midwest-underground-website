# Module 2.1: Cost Database

## Overview

This module creates a CRUD interface for managing cost items used in estimating. It provides a centralized database for labor rates, equipment costs, material pricing, and subcontractor rates, with support for production rates and overhead factors.

## Outcome

A fully functional cost database management system that allows users to:
- Add, edit, and delete cost items across four categories
- Organize items with production rates and overhead factors
- Store cost data in a JSON file for use in the estimate builder
- Search and filter cost items by category and description

## Key Behaviors

1. **CRUD Operations:**
   - Create new cost items with complete schema
   - Edit existing cost items (all fields modifiable)
   - Delete cost items with confirmation prompt
   - Duplicate cost items for quick entry

2. **Category Management:**
   - Four primary categories: Labor, Equipment, Materials, Subcontractors
   - Filter view by category
   - Category-specific fields (e.g., production rates for labor)

3. **Cost Item Schema:**
   - ID (auto-generated UUID)
   - Category (dropdown: labor/equipment/materials/subs)
   - Description (text, e.g., "HDD Crew - 2 person")
   - Unit (text, e.g., "hour", "day", "linear foot", "each")
   - Rate (number, cost per unit)
   - Production Rate (number, units per hour/day, optional)
   - Overhead Factor (percentage, e.g., 1.15 for 15% overhead)
   - Notes (optional text field)
   - Active status (boolean, for archiving without deleting)

4. **Data Validation:**
   - Required fields: category, description, unit, rate
   - Numeric validation for rate, production_rate, overhead_factor
   - Prevent duplicate descriptions within same category
   - Overhead factor range: 1.0 to 2.0 (100% to 200%)

5. **Search and Filter:**
   - Live search by description
   - Filter by category
   - Filter by active/inactive status
   - Sort by description, rate, category

6. **Data Persistence:**
   - Save to `dashboard/api/data/cost-items.json`
   - Auto-save on every change
   - Load existing data on page load
   - Export cost database to CSV

## Allowed Files

**Create:**
- `dashboard/cost-database.html` - Main UI for cost database management
- `dashboard/js/cost-database.js` - JavaScript module for CRUD operations
- `dashboard/api/data/cost-items.json` - JSON data file for cost items
- `dashboard/css/cost-database.css` - Styles specific to cost database (optional, can use existing dashboard.css)

**Modify:**
- None (this is an independent feature)

## Data Schema

### cost-items.json Structure

```json
{
  "cost_items": [
    {
      "id": "uuid-v4-string",
      "category": "labor|equipment|materials|subs",
      "description": "HDD Crew - 2 person",
      "unit": "hour",
      "rate": 185.00,
      "production_rate": 50.0,
      "overhead_factor": 1.15,
      "notes": "Standard bore crew for 4-6 inch pipe",
      "active": true,
      "created_at": "2025-11-22T10:00:00Z",
      "updated_at": "2025-11-22T10:00:00Z"
    },
    {
      "id": "uuid-v4-string-2",
      "category": "equipment",
      "description": "Mini Excavator Rental",
      "unit": "day",
      "rate": 450.00,
      "production_rate": null,
      "overhead_factor": 1.10,
      "notes": "Daily rental rate including fuel",
      "active": true,
      "created_at": "2025-11-22T10:00:00Z",
      "updated_at": "2025-11-22T10:00:00Z"
    },
    {
      "id": "uuid-v4-string-3",
      "category": "materials",
      "description": "2-inch HDPE Pipe",
      "unit": "linear foot",
      "rate": 1.25,
      "production_rate": null,
      "overhead_factor": 1.20,
      "notes": "DR11 HDPE pipe for fiber conduit",
      "active": true,
      "created_at": "2025-11-22T10:00:00Z",
      "updated_at": "2025-11-22T10:00:00Z"
    },
    {
      "id": "uuid-v4-string-4",
      "category": "subs",
      "description": "Electrical Subcontractor",
      "unit": "lump sum",
      "rate": 5000.00,
      "production_rate": null,
      "overhead_factor": 1.05,
      "notes": "Power drop and service connection",
      "active": true,
      "created_at": "2025-11-22T10:00:00Z",
      "updated_at": "2025-11-22T10:00:00Z"
    }
  ],
  "metadata": {
    "version": "1.0",
    "last_updated": "2025-11-22T10:00:00Z",
    "total_items": 4
  }
}
```

### Field Definitions

- **id:** Unique identifier (UUID v4)
- **category:** One of: "labor", "equipment", "materials", "subs"
- **description:** Human-readable name/description (required, max 200 chars)
- **unit:** Unit of measure (required, e.g., "hour", "day", "lf", "each", "lump sum")
- **rate:** Cost per unit in USD (required, positive number)
- **production_rate:** Units produced per time period (optional, positive number or null)
- **overhead_factor:** Multiplier for overhead/profit (default 1.0, range 1.0-2.0)
- **notes:** Additional details (optional, max 500 chars)
- **active:** Boolean flag for soft delete (default true)
- **created_at:** ISO 8601 timestamp
- **updated_at:** ISO 8601 timestamp

## Dependencies

**External:**
- None (independent feature, can be built immediately after Phase 0)

**Internal:**
- Existing dashboard CSS framework
- Existing dashboard navigation structure

**Libraries:**
- None (pure vanilla JavaScript)

## Skills Needed

1. **JavaScript:**
   - DOM manipulation
   - Event handling
   - Form validation
   - Local storage/JSON file handling
   - UUID generation

2. **HTML/CSS:**
   - Responsive table design
   - Form layouts
   - Modal dialogs for add/edit
   - Dashboard integration

3. **Data Management:**
   - CRUD operation patterns
   - Client-side JSON persistence
   - Data validation
   - Search/filter algorithms

## Constraints

1. **Technology:**
   - Vanilla JavaScript only (no frameworks)
   - Client-side JSON file storage (no backend)
   - Must work with existing dashboard layout

2. **Data:**
   - All data stored in `dashboard/api/data/cost-items.json`
   - File must be readable/writable by browser
   - Manual backup strategy (export to CSV)

3. **Performance:**
   - Support up to 500 cost items without performance degradation
   - Live search should respond in < 100ms

4. **UI/UX:**
   - Mobile-responsive design (375px to 1920px+)
   - Accessible (WCAG 2.1 AA)
   - Consistent with existing dashboard design

## UI Components

### Main Page Layout

1. **Header:**
   - Page title: "Cost Database"
   - "Add New Item" button (primary CTA)
   - Search input (live filter)
   - Category filter dropdown

2. **Cost Items Table:**
   - Columns: Category | Description | Unit | Rate | Production Rate | Overhead | Actions
   - Row actions: Edit | Duplicate | Delete
   - Sortable columns
   - Pagination (25 items per page)

3. **Add/Edit Modal:**
   - Form fields for all schema properties
   - Category-specific field visibility (e.g., production rate for labor)
   - Validation feedback
   - Save/Cancel buttons

4. **Delete Confirmation:**
   - Modal with item description
   - "Are you sure?" message
   - Confirm/Cancel buttons

### Responsive Breakpoints

- **Mobile (375px-767px):** Stack table as cards, hide less critical columns
- **Tablet (768px-1023px):** Scrollable table
- **Desktop (1024px+):** Full table view

## Testing Strategy

### Unit Tests (Manual)

1. **CRUD Operations:**
   - Create cost item with all fields
   - Edit existing cost item
   - Delete cost item
   - Duplicate cost item

2. **Validation:**
   - Required field validation
   - Numeric field validation
   - Overhead factor range validation
   - Duplicate description prevention

3. **Search/Filter:**
   - Live search by description
   - Filter by category
   - Combined search and filter
   - Clear filters

4. **Data Persistence:**
   - Save to JSON file
   - Load from JSON file
   - Handle missing/corrupt JSON file
   - Export to CSV

### E2E Tests (Playwright)

1. Add new cost item and verify in table
2. Edit cost item and verify changes persist
3. Delete cost item and verify removal
4. Search/filter and verify results
5. Export to CSV and verify file download

## Implementation Notes

(To be added after implementation)

## Known Limitations

(To be added after implementation)

## Future Enhancements

- Import cost items from CSV
- Historical rate tracking (price changes over time)
- Cost item templates/presets
- Multi-currency support
- Integration with accounting software
