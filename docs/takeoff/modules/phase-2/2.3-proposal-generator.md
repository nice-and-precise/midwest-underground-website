# Module 2.3: Proposal Generator

## Overview

This module creates a professional PDF proposal generator that transforms estimates into branded, client-ready proposals using jsPDF. It provides customizable templates with company branding, project details, line-item breakdowns, terms and conditions, and professional formatting.

## Outcome

A fully functional proposal generator that allows users to:
- Select an estimate to convert into a proposal
- Customize proposal header information (client, project, date)
- Generate branded PDF with company logo and colors
- Include detailed line-item breakdown or summary view
- Add standard terms and conditions
- Preview proposal before generating
- Download PDF for email or printing

## Key Behaviors

1. **Estimate Selection:**
   - Load list of estimates from `dashboard/api/data/estimates.json`
   - Display estimate number, name, total, and status
   - Select estimate to generate proposal from
   - Load estimate data into proposal template

2. **Proposal Customization:**
   - Edit client information (name, contact, address)
   - Edit project information (name, location, scope)
   - Select proposal type: Detailed (all line items) or Summary (category totals)
   - Add cover letter/introduction text
   - Add exclusions/assumptions text
   - Add payment terms
   - Set proposal validity period (e.g., 30 days)

3. **PDF Generation (jsPDF):**
   - Multi-page support with automatic page breaks
   - Company branding (logo, colors, contact info)
   - Professional typography and layout
   - Header and footer on each page
   - Tables for line items with proper formatting
   - Total box with emphasis

4. **Template Structure:**
   - **Page 1: Cover Page**
     - Company logo and branding
     - Proposal title and number
     - Client information
     - Project name and location
     - Date and validity period
     - Prepared by information

   - **Page 2: Introduction/Scope**
     - Cover letter text
     - Project scope summary
     - Key assumptions

   - **Page 3+: Cost Breakdown**
     - Line items table (detailed view) OR
     - Category summary table (summary view)
     - Subtotal, profit, total in emphasized box

   - **Final Page: Terms & Conditions**
     - Payment terms
     - Exclusions
     - Warranty information
     - Acceptance signature block

5. **Preview Mode:**
   - Generate preview in iframe or new tab
   - Allow edits before final download
   - Show page count and file size estimate

6. **Data Persistence:**
   - Save proposal metadata to `dashboard/api/data/proposals.json`
   - Track proposal version history
   - Link proposals to estimates
   - Record download/sent dates

## Allowed Files

**Create:**
- `dashboard/proposals.html` - Main UI for proposal generation
- `dashboard/js/proposal-generator.js` - JavaScript module for PDF generation
- `dashboard/templates/proposal-template.js` - Reusable PDF template logic
- `dashboard/api/data/proposals.json` - JSON data file for proposal metadata

**Modify:**
- `dashboard/estimates.html` - Add "Generate Proposal" button (optional)

## Data Schema

### proposals.json Structure

```json
{
  "proposals": [
    {
      "id": "uuid-v4-string",
      "proposal_number": "PROP-2025-001",
      "estimate_id": "uuid-from-estimates.json",
      "client_info": {
        "name": "City of Willmar",
        "contact_person": "John Smith",
        "email": "jsmith@willmarmn.gov",
        "phone": "(320) 555-0100",
        "address": "333 SW 6th St, Willmar, MN 56201"
      },
      "project_info": {
        "name": "Main Street Fiber Install",
        "location": "Main Street, Willmar, MN",
        "scope": "Installation of 450 LF of fiber optic conduit via HDD"
      },
      "proposal_type": "detailed",
      "cover_letter": "We are pleased to submit this proposal for the installation of fiber optic conduit along Main Street...",
      "exclusions": "This proposal does not include utility locates, permits, or traffic control.",
      "payment_terms": "50% deposit upon acceptance, 50% upon completion",
      "validity_days": 30,
      "total_amount": 5876.90,
      "status": "sent",
      "version": 1,
      "created_at": "2025-11-22T10:00:00Z",
      "sent_at": "2025-11-22T14:00:00Z",
      "downloaded_at": "2025-11-22T14:05:00Z",
      "pdf_filename": "PROP-2025-001_Main_Street_Fiber.pdf"
    }
  ],
  "metadata": {
    "version": "1.0",
    "last_updated": "2025-11-22T14:05:00Z",
    "total_proposals": 1
  }
}
```

### Field Definitions

- **id:** Unique proposal identifier (UUID v4)
- **proposal_number:** Human-readable proposal number (auto-increment)
- **estimate_id:** Reference to estimate in estimates.json
- **client_info:** Client contact information
- **project_info:** Project details for proposal header
- **proposal_type:** "detailed" (all line items) or "summary" (category totals)
- **cover_letter:** Introduction text for proposal
- **exclusions:** What's not included in the scope
- **payment_terms:** Payment schedule and terms
- **validity_days:** How long proposal is valid (e.g., 30)
- **total_amount:** Total from estimate (cached for quick reference)
- **status:** "draft", "sent", "accepted", "declined"
- **version:** Proposal version (increments on re-generation)
- **created_at:** Timestamp of proposal creation
- **sent_at:** Timestamp when proposal was sent to client (optional)
- **downloaded_at:** Timestamp of PDF download (optional)
- **pdf_filename:** Filename for downloaded PDF

## Dependencies

**Required Modules:**
- Module 2.2 (Estimate Builder) - Needs estimate data from `dashboard/api/data/estimates.json`
- Module 2.1 (Cost Database) - Needs cost item descriptions for line items

**External Libraries:**
- **jsPDF** (via CDN): `https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js`
- **jsPDF-AutoTable** (optional, for easier table formatting): `https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js`

## Skills Needed

1. **jsPDF API:**
   - Document creation and configuration
   - Text positioning and formatting
   - Font styles and sizes
   - Multi-page documents with page breaks
   - Adding images (logo)
   - Drawing shapes (lines, boxes)
   - Table generation (manual or via AutoTable plugin)

2. **PDF Layout Design:**
   - Page margins and spacing
   - Typography hierarchy
   - Color scheme application
   - Professional business document layout
   - Header/footer templates

3. **JavaScript:**
   - Async data loading (estimates, cost items)
   - Template rendering logic
   - String formatting and interpolation
   - Date formatting
   - File download triggers

4. **HTML/CSS:**
   - Proposal preview interface
   - Form for proposal customization
   - Responsive design for proposal builder UI

## Constraints

1. **Technology:**
   - jsPDF library only (client-side PDF generation)
   - No backend PDF rendering
   - Must work in all modern browsers

2. **File Size:**
   - Keep logo under 100KB
   - Target PDF size < 500KB for single proposal
   - Optimize fonts (use jsPDF built-in fonts)

3. **Performance:**
   - PDF generation should complete in < 3 seconds
   - Preview updates in real-time as user edits

4. **Design:**
   - Match Midwest Underground branding
   - Professional business document appearance
   - Print-ready (8.5" x 11" letter size)
   - High-quality output (readable at 100% zoom)

## jsPDF Template Structure

### Proposal Template API

The `dashboard/templates/proposal-template.js` module exports a reusable template function:

```javascript
// proposal-template.js

/**
 * Generate a PDF proposal from estimate data
 * @param {Object} proposalData - Proposal configuration
 * @param {Object} estimateData - Estimate line items and totals
 * @param {Object} companyInfo - Company branding and contact info
 * @returns {jsPDF} - jsPDF document instance
 */
function generateProposalPDF(proposalData, estimateData, companyInfo) {
  const doc = new jsPDF({
    orientation: 'portrait',
    unit: 'in',
    format: 'letter'
  });

  // Add pages
  addCoverPage(doc, proposalData, companyInfo);
  addScopePage(doc, proposalData);
  addCostBreakdownPage(doc, proposalData, estimateData);
  addTermsPage(doc, proposalData, companyInfo);

  return doc;
}

/**
 * Page 1: Cover Page
 */
function addCoverPage(doc, proposalData, companyInfo) {
  // Company logo (top left)
  // Company name and contact info (top right)
  // Proposal title and number (center)
  // Client information (center)
  // Project name and location (center)
  // Date and validity (bottom)
}

/**
 * Page 2: Introduction/Scope
 */
function addScopePage(doc, proposalData) {
  // Cover letter text
  // Project scope summary
  // Key assumptions
}

/**
 * Page 3+: Cost Breakdown
 */
function addCostBreakdownPage(doc, proposalData, estimateData) {
  if (proposalData.proposal_type === 'detailed') {
    // Table with all line items
    addDetailedLineItemsTable(doc, estimateData.line_items);
  } else {
    // Summary table by category
    addSummaryTable(doc, estimateData.totals.by_category);
  }

  // Totals box
  addTotalsBox(doc, estimateData.totals);
}

/**
 * Final Page: Terms & Conditions
 */
function addTermsPage(doc, proposalData, companyInfo) {
  // Payment terms
  // Exclusions
  // Warranty information
  // Acceptance signature block
}

/**
 * Header template (applied to all pages)
 */
function addHeader(doc, pageNumber, totalPages) {
  // Company name
  // Page number (e.g., "Page 2 of 5")
}

/**
 * Footer template (applied to all pages)
 */
function addFooter(doc, companyInfo) {
  // Company address
  // Phone, email, website
}
```

### Company Branding

```javascript
const COMPANY_INFO = {
  name: "Midwest Underground of Minnesota Inc",
  address: "4320 County Rd 8 SE, Willmar, MN 56201",
  phone: "(320) 382-6636",
  email: "info@midwestundergroundmn.com",
  website: "www.midwestundergroundmn.com",
  logo_path: "dashboard/assets/logo.png",
  colors: {
    primary: "#003B5C",    // Deep Blue
    secondary: "#FF6B35",  // Safety Orange
    text: "#333333",
    subtle: "#666666"
  }
};
```

### Typography Hierarchy

```javascript
const FONTS = {
  heading1: { size: 20, style: 'bold' },      // Proposal title
  heading2: { size: 16, style: 'bold' },      // Section headers
  heading3: { size: 14, style: 'bold' },      // Subsection headers
  body: { size: 11, style: 'normal' },        // Body text
  small: { size: 9, style: 'normal' },        // Footer text
  tableHeader: { size: 10, style: 'bold' },   // Table headers
  tableBody: { size: 10, style: 'normal' }    // Table content
};
```

### Page Layout

```javascript
const LAYOUT = {
  margins: {
    top: 0.75,
    right: 0.75,
    bottom: 0.75,
    left: 0.75
  },
  pageWidth: 8.5,
  pageHeight: 11,
  contentWidth: 7.0,  // pageWidth - left - right
  contentHeight: 9.5  // pageHeight - top - bottom
};
```

## UI Components

### Main Page Layout

1. **Proposal Builder Form:**
   - Estimate selector (dropdown)
   - Client info fields (name, contact, address)
   - Project info fields (name, location, scope)
   - Proposal type selector (detailed/summary)
   - Cover letter textarea
   - Exclusions textarea
   - Payment terms textarea
   - Validity period input (days)

2. **Preview Section:**
   - Live preview of first page (optional, using canvas)
   - Estimated page count
   - File size estimate
   - "Regenerate Preview" button

3. **Actions:**
   - "Generate PDF" button (primary CTA)
   - "Save Draft" button
   - "Download PDF" button (triggers jsPDF save)

4. **Proposal History Table:**
   - List of previously generated proposals
   - Columns: Proposal #, Estimate, Client, Total, Status, Date, Actions
   - Actions: View, Download, Resend

## Testing Strategy

### Unit Tests (Manual)

1. **PDF Generation:**
   - Generate detailed proposal
   - Generate summary proposal
   - Verify all pages render
   - Check page breaks

2. **Template Rendering:**
   - Verify company branding appears
   - Check client/project info renders
   - Verify line items table formats correctly
   - Check totals box calculation

3. **Data Persistence:**
   - Save proposal metadata
   - Load existing proposal
   - Track version history
   - Update status

4. **Edge Cases:**
   - Estimate with 50+ line items (pagination)
   - Long client addresses (text wrap)
   - Special characters in descriptions
   - Missing logo file

### E2E Tests (Playwright)

1. Select estimate and generate proposal
2. Customize client/project info
3. Generate detailed proposal PDF
4. Verify PDF downloads successfully
5. Generate summary proposal PDF
6. Save proposal draft
7. Load existing proposal and regenerate

## PDF Output Example

### Cover Page Layout

```
+-----------------------------------------------------------+
|  [LOGO]              Midwest Underground of Minnesota Inc |
|                      4320 County Rd 8 SE                  |
|                      Willmar, MN 56201                    |
|                      (320) 382-6636                       |
|                                                           |
|                                                           |
|                   CONSTRUCTION PROPOSAL                    |
|                                                           |
|                     PROP-2025-001                         |
|                                                           |
|                                                           |
|  PREPARED FOR:                                            |
|  City of Willmar                                          |
|  John Smith                                               |
|  333 SW 6th St                                            |
|  Willmar, MN 56201                                        |
|  (320) 555-0100                                           |
|                                                           |
|  PROJECT:                                                 |
|  Main Street Fiber Install                                |
|  Main Street, Willmar, MN                                 |
|                                                           |
|                                                           |
|  Date: November 22, 2025                                  |
|  Valid for: 30 days                                       |
|                                                           |
|  Prepared by: Midwest Underground                         |
+-----------------------------------------------------------+
```

### Cost Breakdown Page (Detailed)

```
+-----------------------------------------------------------+
|  COST BREAKDOWN                                           |
|                                                           |
|  Description            Qty    Unit      Rate    Total    |
|  ---------------------------------------------------------|
|  HDD Crew - 2 person   9.01   hours   $185.00  $1,916.88 |
|  2-inch HDPE Pipe     450.5   LF       $1.25     $675.76 |
|  Traffic Control        1     LS    $2,500.00  $2,750.00 |
|                                                           |
|                                         Subtotal: $5,342.64|
|                                      Profit (10%): $534.26|
|                                                           |
|                        +-----------------------------+    |
|                        |  TOTAL ESTIMATE: $5,876.90  |    |
|                        +-----------------------------+    |
+-----------------------------------------------------------+
```

## Implementation Notes

(To be added after implementation)

## Known Limitations

(To be added after implementation)

## Future Enhancements

- Multiple proposal templates (simple, detailed, executive)
- Custom branding per client
- Digital signature capture
- Email proposal directly from dashboard
- Proposal comparison (version diffs)
- Client portal integration (Module 3.4)
- Mobile-optimized PDF preview
- Proposal analytics (open rate, view time)
