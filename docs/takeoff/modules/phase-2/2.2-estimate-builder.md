<!-- TOC -->

## Table of Contents

- [Overview](#overview)
- [Outcome](#outcome)
- [Key Behaviors](#key-behaviors)
- [Allowed Files](#allowed-files)
- [Data Schema](#data-schema)
  - [estimates.json Structure](#estimatesjson-structure)
  - [Line Item Field Definitions](#line-item-field-definitions)
- [Dependencies](#dependencies)
- [Skills Needed](#skills-needed)
- [Constraints](#constraints)
- [UI Components](#ui-components)
  - [Main Page Layout](#main-page-layout)
  - [Calculation Display](#calculation-display)
- [Testing Strategy](#testing-strategy)
  - [Unit Tests (Manual)](#unit-tests-manual)
  - [E2E Tests (Playwright)](#e2e-tests-playwright)
- [Calculation Examples](#calculation-examples)
  - [Example 1: HDD Labor with Production Rate](#example-1-hdd-labor-with-production-rate)
  - [Example 2: Materials without Production Rate](#example-2-materials-without-production-rate)
  - [Example 3: Estimate Total with Profit](#example-3-estimate-total-with-profit)
- [Implementation Notes](#implementation-notes)
- [Known Limitations](#known-limitations)
- [Future Enhancements](#future-enhancements)

<!-- /TOC -->

# Module 2.2: Estimate Builder

## Overview

This module creates the estimate builder interface that maps takeoff quantities to cost items from the cost database, applies production rates, calculates line-item costs, and generates final estimate totals with overhead and profit margins.

## Outcome

A fully functional estimate builder that allows users to:
- Select a completed takeoff as the basis for an estimate
- Map each quantity category to one or more cost items
- Apply production rates and calculate labor/equipment hours
- Calculate line-item costs with overhead factors
- Add markup for profit
- Generate detailed estimate totals
- Save estimates for proposal generation

## Key Behaviors

1. **Takeoff Selection:**
   - Load list of completed takeoffs from `dashboard/api/data/takeoffs.json`
   - Display takeoff name, project, date, and total quantities
   - Select takeoff to build estimate from
   - Load takeoff quantities into estimate builder

2. **Cost Item Mapping:**
   - For each quantity category (HDD, fiber, trench, etc.):
     - Display quantity value and unit
     - Select one or more cost items from cost database
     - Enter multiplier/quantity override if needed
     - Calculate cost for each line item

3. **Production Rate Calculation:**
   - For labor cost items with production rates:
     - Calculate hours required: `quantity / production_rate`
     - Display calculated hours
     - Calculate labor cost: `hours × hourly_rate × overhead_factor`

4. **Line Item Calculation:**
   - For each cost item mapped to a quantity:
     - Base cost: `quantity × unit_rate`
     - With overhead: `base_cost × overhead_factor`
     - Display both base and overhead-adjusted costs

5. **Estimate Totals:**
   - Subtotal (sum of all line items with overhead)
   - Profit margin (percentage, e.g., 10%)
   - Total estimate: `subtotal × (1 + profit_margin)`
   - Display breakdown by category (labor, equipment, materials, subs)

6. **Manual Line Items:**
   - Add custom line items not tied to takeoff quantities
   - Fields: description, quantity, unit, rate, overhead_factor
   - Include in estimate totals

7. **Estimate Metadata:**
   - Estimate name/number
   - Project reference
   - Date created/updated
   - Status (draft, final, approved)
   - Notes/assumptions

8. **Data Persistence:**
   - Save to `dashboard/api/data/estimates.json`
   - Auto-save on changes
   - Load existing estimates for editing
   - Export estimate to PDF (via Module 2.3)

## Allowed Files

**Create:**
- `dashboard/estimates.html` - Main UI for estimate builder
- `dashboard/js/estimate-builder.js` - JavaScript module for estimate calculations
- `dashboard/api/data/estimates.json` - JSON data file for estimates

**Modify:**
- None (integrates with existing cost database and takeoff data via read operations)

## Data Schema

### estimates.json Structure

```json
{
  "estimates": [
    {
      "id": "uuid-v4-string",
      "estimate_number": "EST-2025-001",
      "name": "Main Street Fiber Install - Estimate",
      "takeoff_id": "uuid-from-takeoffs.json",
      "project_info": {
        "project_name": "Main Street Fiber Install",
        "client": "City of Willmar",
        "location": "Main Street, Willmar, MN"
      },
      "line_items": [
        {
          "id": "line-item-uuid-1",
          "source_type": "takeoff_quantity",
          "quantity_category": "HDD",
          "takeoff_quantity": 450.5,
          "cost_item_id": "uuid-from-cost-items.json",
          "cost_item_description": "HDD Crew - 2 person",
          "quantity": 450.5,
          "unit": "linear foot",
          "production_rate": 50.0,
          "calculated_hours": 9.01,
          "unit_rate": 185.00,
          "base_cost": 1666.85,
          "overhead_factor": 1.15,
          "total_cost": 1916.88
        },
        {
          "id": "line-item-uuid-2",
          "source_type": "takeoff_quantity",
          "quantity_category": "fiber",
          "takeoff_quantity": 450.5,
          "cost_item_id": "uuid-from-cost-items.json",
          "cost_item_description": "2-inch HDPE Pipe",
          "quantity": 450.5,
          "unit": "linear foot",
          "production_rate": null,
          "calculated_hours": null,
          "unit_rate": 1.25,
          "base_cost": 563.13,
          "overhead_factor": 1.20,
          "total_cost": 675.76
        },
        {
          "id": "line-item-uuid-3",
          "source_type": "manual",
          "quantity_category": null,
          "takeoff_quantity": null,
          "cost_item_id": null,
          "cost_item_description": "Traffic Control",
          "quantity": 1,
          "unit": "lump sum",
          "production_rate": null,
          "calculated_hours": null,
          "unit_rate": 2500.00,
          "base_cost": 2500.00,
          "overhead_factor": 1.10,
          "total_cost": 2750.00
        }
      ],
      "totals": {
        "subtotal": 5342.64,
        "by_category": {
          "labor": 1916.88,
          "equipment": 0.00,
          "materials": 675.76,
          "manual": 2750.00
        },
        "profit_margin": 0.10,
        "profit_amount": 534.26,
        "total_estimate": 5876.90
      },
      "status": "draft",
      "notes": "Assumes normal soil conditions. Does not include utility locates or permits.",
      "created_at": "2025-11-22T10:00:00Z",
      "updated_at": "2025-11-22T11:30:00Z",
      "created_by": "user-id-placeholder"
    }
  ],
  "metadata": {
    "version": "1.0",
    "last_updated": "2025-11-22T11:30:00Z",
    "total_estimates": 1
  }
}
```

### Line Item Field Definitions

- **id:** Unique line item identifier (UUID v4)
- **source_type:** "takeoff_quantity" or "manual"
- **quantity_category:** Category from takeoff (e.g., "HDD", "fiber", "trench"), null for manual
- **takeoff_quantity:** Original quantity from takeoff, null for manual
- **cost_item_id:** Reference to cost item in cost-items.json, null for manual
- **cost_item_description:** Description from cost item or custom for manual
- **quantity:** Actual quantity used in calculation (may differ from takeoff_quantity)
- **unit:** Unit of measure
- **production_rate:** From cost item, used for labor hour calculation
- **calculated_hours:** Hours calculated from quantity/production_rate (labor only)
- **unit_rate:** Cost per unit from cost item or manual entry
- **base_cost:** quantity × unit_rate (before overhead)
- **overhead_factor:** Multiplier from cost item or manual entry
- **total_cost:** base_cost × overhead_factor

## Dependencies

**Required Modules:**
- Module 1.4 (Export & Persistence) - Needs takeoff quantities from `dashboard/api/data/takeoffs.json`
- Module 2.1 (Cost Database) - Needs cost items from `dashboard/api/data/cost-items.json`

**Libraries:**
- None (pure vanilla JavaScript)

## Skills Needed

1. **JavaScript:**
   - Async data loading (multiple JSON files)
   - Complex calculations (production rates, overhead, profit)
   - Form state management
   - Real-time calculation updates
   - Array manipulation (map, filter, reduce)

2. **HTML/CSS:**
   - Multi-step form interface
   - Dynamic table rows (add/remove line items)
   - Responsive layout
   - Cost breakdown visualization

3. **Calculation Logic:**
   - Production rate formulas
   - Overhead factor application
   - Profit margin calculation
   - Rounding and precision handling (2 decimal places for currency)

## Constraints

1. **Technology:**
   - Vanilla JavaScript only
   - Client-side JSON file storage
   - No backend calculations

2. **Data:**
   - Read-only access to takeoffs.json and cost-items.json
   - Estimates stored in estimates.json
   - Must handle missing/deleted references gracefully

3. **Performance:**
   - Real-time recalculation on any line item change
   - Support up to 50 line items per estimate
   - Calculations must complete in < 200ms

4. **Calculation Rules:**
   - All currency values rounded to 2 decimal places
   - Hours calculated to 2 decimal places
   - Profit margin as percentage (0.0 to 1.0 range)
   - Overhead factor range: 1.0 to 2.0

## UI Components

### Main Page Layout

1. **Estimate Header:**
   - Estimate number (auto-generated or manual)
   - Estimate name
   - Project info (name, client, location)
   - Status dropdown (draft, final, approved)
   - Save button (auto-save on changes)

2. **Takeoff Selection:**
   - Dropdown of available takeoffs
   - Display takeoff summary (quantities by category)
   - "Load Takeoff" button

3. **Line Items Table:**
   - Columns: Source | Category | Description | Qty | Unit | Prod. Rate | Hours | Unit Rate | Base Cost | OH Factor | Total
   - Each row: Editable quantity, cost item selector, calculated fields
   - Add line item button (manual items)
   - Remove line item button per row

4. **Cost Item Selector Modal:**
   - Search/filter cost items
   - Category filter
   - Select cost item and close modal
   - Display: description, unit, rate, production rate

5. **Totals Panel (Right Sidebar):**
   - Subtotal
   - Breakdown by category (collapsible)
   - Profit margin input (percentage)
   - Profit amount (calculated)
   - Total estimate (bold, large font)

6. **Notes Section:**
   - Textarea for assumptions, exclusions, notes
   - Display below line items table

7. **Actions:**
   - Save estimate button
   - Generate proposal button (links to Module 2.3)
   - Export to PDF button
   - Print estimate button

### Calculation Display

For labor items with production rates:
```
450.5 LF ÷ 50 LF/hour = 9.01 hours
9.01 hours × $185.00/hour = $1,666.85 (base)
$1,666.85 × 1.15 = $1,916.88 (with overhead)
```

For materials/equipment:
```
450.5 LF × $1.25/LF = $563.13 (base)
$563.13 × 1.20 = $675.76 (with overhead)
```

## Testing Strategy

### Unit Tests (Manual)

1. **Takeoff Loading:**
   - Load takeoff quantities
   - Map quantities to line items
   - Handle missing takeoff data

2. **Cost Item Selection:**
   - Select cost item from database
   - Apply cost item properties to line item
   - Handle deleted cost items

3. **Calculations:**
   - Production rate calculation (labor)
   - Base cost calculation
   - Overhead factor application
   - Profit margin calculation
   - Category subtotals

4. **Manual Line Items:**
   - Add manual line item
   - Edit manual line item
   - Remove line item
   - Include in totals

5. **Data Persistence:**
   - Save estimate
   - Load existing estimate
   - Auto-save on changes
   - Handle missing/corrupt data

### E2E Tests (Playwright)

1. Create new estimate from takeoff
2. Add cost items to line items
3. Verify calculations are correct
4. Add manual line item
5. Change profit margin and verify total updates
6. Save estimate and reload page
7. Verify estimate loads correctly

## Calculation Examples

### Example 1: HDD Labor with Production Rate

- Takeoff quantity: 450.5 LF
- Cost item: "HDD Crew - 2 person"
- Unit rate: $185.00/hour
- Production rate: 50 LF/hour
- Overhead factor: 1.15

**Calculation:**
```
Hours = 450.5 LF ÷ 50 LF/hour = 9.01 hours
Base cost = 9.01 hours × $185.00/hour = $1,666.85
Total cost = $1,666.85 × 1.15 = $1,916.88
```

### Example 2: Materials without Production Rate

- Takeoff quantity: 450.5 LF
- Cost item: "2-inch HDPE Pipe"
- Unit rate: $1.25/LF
- Production rate: null
- Overhead factor: 1.20

**Calculation:**
```
Base cost = 450.5 LF × $1.25/LF = $563.13
Total cost = $563.13 × 1.20 = $675.76
```

### Example 3: Estimate Total with Profit

- Subtotal (all line items): $5,342.64
- Profit margin: 10% (0.10)

**Calculation:**
```
Profit amount = $5,342.64 × 0.10 = $534.26
Total estimate = $5,342.64 + $534.26 = $5,876.90
```

## Implementation Notes

(To be added after implementation)

## Known Limitations

(To be added after implementation)

## Future Enhancements

- Import line items from previous estimates
- Apply standard markup templates (e.g., "MN DOT rates")
- Contingency line items (percentage of subtotal)
- Multi-scenario estimates (best case, worst case, most likely)
- Comparison with historical project costs
- Integration with accounting software for actual cost tracking
