<!-- TOC -->

## Table of Contents

- [Overview](#overview)
- [Outcome](#outcome)
- [Key Behaviors](#key-behaviors)
  - [Behavior 1: Project Data Model](#behavior-1-project-data-model)
  - [Behavior 2: Advanced Search Interface](#behavior-2-advanced-search-interface)
  - [Behavior 3: Similarity Scoring Algorithm](#behavior-3-similarity-scoring-algorithm)
  - [Behavior 4: Production Rate Analysis](#behavior-4-production-rate-analysis)
  - [Behavior 5: Trend Visualization (Chart.js)](#behavior-5-trend-visualization-chartjs)
  - [Behavior 6: Project Comparison View](#behavior-6-project-comparison-view)
  - [Behavior 7: Data Import/Export](#behavior-7-data-importexport)
- [Allowed Files](#allowed-files)
- [Dependencies](#dependencies)
  - [External Libraries](#external-libraries)
  - [Internal Modules](#internal-modules)
  - [Data Schema Requirements](#data-schema-requirements)
- [Skills Needed](#skills-needed)
  - [Technical Skills](#technical-skills)
  - [Domain Knowledge](#domain-knowledge)
  - [Research Areas (To Be Investigated During Planning)](#research-areas-to-be-investigated-during-planning)
- [Constraints](#constraints)
  - [Technical Constraints](#technical-constraints)
  - [Data Constraints](#data-constraints)
  - [User Experience Constraints](#user-experience-constraints)
- [Research Needed](#research-needed)
  - [1. Similarity Scoring Weights](#1-similarity-scoring-weights)
  - [2. Production Rate Outlier Handling](#2-production-rate-outlier-handling)
  - [3. Search Performance Optimization](#3-search-performance-optimization)
  - [4. Data Import Format](#4-data-import-format)
- [Implementation Notes](#implementation-notes)
- [Known Limitations](#known-limitations)
- [Testing Considerations](#testing-considerations)
  - [Unit Tests (JavaScript)](#unit-tests-javascript)
  - [E2E Tests (Playwright)](#e2e-tests-playwright)
  - [Manual Testing](#manual-testing)
- [Integration Points](#integration-points)
  - [With Module 2.2 (Estimate Builder)](#with-module-22-estimate-builder)
  - [With Module 2.3 (Proposal Generator)](#with-module-23-proposal-generator)
  - [With Module 3.3 (Change Orders)](#with-module-33-change-orders)
- [Security Considerations](#security-considerations)
- [Success Criteria](#success-criteria)

<!-- /TOC -->

# Module 3.2: Historical Project Database

## Overview

This module creates a searchable database of past HDD/fiber installation projects, enabling users to find similar jobs, compare production rates, and leverage historical data for more accurate estimating. The system uses intelligent similarity scoring to suggest comparable projects and analyze trends over time.

**Complexity Level:** ADVANCED
**Estimated Implementation:** 6-10 hours
**Research Required:** Search algorithms, similarity metrics, data visualization techniques

---

## Outcome

A comprehensive historical project search and analysis system that:
- Stores completed project data (scope, quantities, costs, actual vs estimated)
- Enables search by location, project type, size, date range
- Suggests similar projects based on scope and characteristics
- Calculates average production rates from historical data
- Visualizes trends (cost per foot, bore success rate, crew productivity)
- Exports historical data for bidding new projects

**User Experience:**
1. User preparing new estimate searches for similar past projects
2. System returns ranked list of comparable jobs
3. User reviews actual costs and production rates from similar projects
4. User applies historical average rates to new estimate
5. User views trend charts showing how costs have changed over time
6. User exports comparison report to validate bid pricing

---

## Key Behaviors

### Behavior 1: Project Data Model
- Store completed projects in `projects.json`
- Schema includes: Project ID, name, client, location (city, county, GPS coords)
- Project type: HDD, fiber pull, open trench, combo
- Scope: Total bore length, conduit size, soil type, number of bores
- Costs: Estimated vs actual, breakdown by cost category
- Timeline: Bid date, start date, completion date, actual days
- Production rates: Feet per day, crew size, equipment used
- Outcomes: Success/challenges, change orders, lessons learned

### Behavior 2: Advanced Search Interface
- **Text Search:** Project name, client name, location (fuzzy matching)
- **Filters:**
  - Project type (checkboxes: HDD, fiber, trench, etc.)
  - Date range (start date, end date)
  - Location radius (within X miles of address/GPS)
  - Size range (total feet: min, max)
  - Soil type (sand, clay, rock, mixed)
  - Cost range (min, max total cost)
- **Sort Options:** Date (newest/oldest), size, cost, production rate, similarity score
- **Results Display:** Paginated table with key metrics, click to view details

### Behavior 3: Similarity Scoring Algorithm
- Calculate similarity score (0-100) between search criteria and each historical project
- Factors weighted in similarity:
  - **Project Type** (30%): Exact match = 30, similar = 15, different = 0
  - **Size** (25%): Calculate % difference in total feet, scale to score
  - **Location** (20%): Distance-based scoring (closer = higher)
  - **Soil Type** (15%): Exact match = 15, similar = 7, different = 0
  - **Date Recency** (10%): More recent projects score higher
- Display similarity percentage in search results
- Highlight "Best Match" project with highest similarity score

### Behavior 4: Production Rate Analysis
- **Calculation Methods:**
  - Average feet per day (total feet ÷ actual days)
  - Feet per crew hour (total feet ÷ crew size ÷ hours)
  - Cost per linear foot (total cost ÷ total feet)
  - Equipment utilization (actual days ÷ estimated days)
- **Aggregation:**
  - Calculate average rates across all similar projects
  - Show min, max, median for each metric
  - Identify outliers (projects >2 standard deviations from mean)
- **Filtering:**
  - Include/exclude projects by date range
  - Exclude outliers from average calculations
  - Weight by project size (larger projects = more influence)

### Behavior 5: Trend Visualization (Chart.js)
- **Line Charts:**
  - Cost per foot over time (last 1 year, 3 years, 5 years)
  - Average production rate trend (improving/declining)
  - Project size distribution over time
- **Bar Charts:**
  - Projects by soil type (count and avg production rate)
  - Projects by season (winter vs summer productivity)
  - Cost category breakdown (labor, equipment, materials, subs)
- **Interactive Features:**
  - Hover to see exact values
  - Click data points to drill down to projects
  - Toggle data series on/off
  - Export chart as PNG image

### Behavior 6: Project Comparison View
- Select 2-5 projects to compare side-by-side
- Display comparison table with key metrics:
  - Scope (total feet, bore count, soil type)
  - Costs (estimated vs actual, variance %)
  - Timeline (estimated vs actual days)
  - Production rates (feet/day, cost/foot)
  - Challenges/notes
- Highlight differences (color-code: green = good, red = bad, yellow = neutral)
- Calculate average across selected projects
- Export comparison as CSV or PDF

### Behavior 7: Data Import/Export
- **Import:** CSV or JSON file with project data (bulk upload historical records)
- **Export:**
  - Search results as CSV (for Excel analysis)
  - Production rate summary as PDF (for estimating reports)
  - Project comparison table as PDF (for bid reviews)
  - Historical database backup as JSON (full export)
- **Validation:** Ensure imported data matches schema, show error report for invalid rows

---

## Allowed Files

**Create:**
- `dashboard/historical.html` - Historical database search interface
- `dashboard/js/historical.js` - Search, similarity scoring, trend analysis logic
- `dashboard/api/data/projects.json` - Historical project database

**Modify:**
- `dashboard/estimates.html` - Add "Search Historical" button to estimate builder (quick access to similar projects)
- `dashboard/proposals.html` - Add option to include historical comparison in proposal appendix

**Read (Dependencies):**
- `dashboard/api/data/estimates.json` - Completed estimates can be auto-added to historical database
- `dashboard/css/dashboard.css` - Existing styles for layout consistency

---

## Dependencies

### External Libraries
- **Chart.js** (already in project) - For trend visualizations
- **Fuse.js** (optional) - Fuzzy text search library
  - CDN: `https://cdn.jsdelivr.net/npm/fuse.js@7.0.0`
  - Enables typo-tolerant search for project names, clients, locations
- **PapaParse** (optional) - CSV parsing for import/export
  - CDN: `https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js`

### Internal Modules
- **Module 2.2 (Estimate Builder)** - Needs completed estimates for historical data population
- **Module 1.4 (Export/Persistence)** - Data export patterns to follow

### Data Schema Requirements

**projects.json:**
```json
{
  "projects": [
    {
      "id": "uuid",
      "name": "Willmar Fiber Ring - Phase 2",
      "client": "City of Willmar",
      "location": {
        "address": "123 Main St, Willmar, MN",
        "city": "Willmar",
        "county": "Kandiyohi",
        "state": "MN",
        "gps": { "lat": 45.1219, "lng": -95.0434 }
      },
      "projectType": "HDD + Fiber Pull",
      "scope": {
        "totalFeet": 4500,
        "boreCount": 3,
        "conduitSize": "2 inch",
        "fiberType": "144-count single mode",
        "soilType": "clay",
        "depthRange": "6-12 feet"
      },
      "costs": {
        "estimated": 125000,
        "actual": 132000,
        "variance": 7000,
        "variancePercent": 5.6,
        "breakdown": {
          "labor": 45000,
          "equipment": 38000,
          "materials": 28000,
          "subcontractors": 21000
        }
      },
      "timeline": {
        "bidDate": "2024-03-15",
        "startDate": "2024-05-01",
        "completionDate": "2024-05-12",
        "estimatedDays": 10,
        "actualDays": 12,
        "variance": 2
      },
      "productionRates": {
        "feetPerDay": 375,
        "costPerFoot": 29.33,
        "crewSize": 4,
        "equipmentUsed": ["D24x40 rig", "mud system", "locator"]
      },
      "outcomes": {
        "success": true,
        "challenges": "Rocky soil in bore 2 required slower drilling",
        "changeOrders": 1,
        "changeOrderValue": 7000,
        "lessonsLearned": "Pre-boring soil analysis would have helped estimate"
      },
      "createdAt": "2024-05-12T16:00:00Z"
    }
  ]
}
```

---

## Skills Needed

### Technical Skills
- **Search Algorithms** - Text search, filtering, sorting, ranking
- **Statistical Analysis** - Mean, median, standard deviation, outlier detection
- **Data Visualization** - Chart.js configuration, interactive charts
- **Similarity Metrics** - Weighted scoring, normalization, distance functions
- **CSV/JSON Parsing** - Data import/export, format validation

### Domain Knowledge
- **HDD Project Characteristics** - What factors make projects comparable?
- **Production Rate Factors** - Soil type, bore size, crew experience, equipment
- **Cost Estimation Patterns** - Historical cost trends, seasonal variations

### Research Areas (To Be Investigated During Planning)
1. **Similarity Algorithm Design:**
   - What weight should each factor have in similarity scoring?
   - How to handle missing data (e.g., project has no GPS coords)?
   - Should similarity be calculated differently for different project types?

2. **Production Rate Normalization:**
   - How to account for different project complexities when averaging?
   - Should outliers be excluded automatically or flagged for review?
   - Best way to weight historical data by recency vs size?

3. **Search Performance:**
   - How many historical projects can be searched client-side before performance degrades?
   - Should we implement indexing or caching for large datasets?
   - When to use fuzzy search vs exact match?

---

## Constraints

### Technical Constraints
- **No Backend Database:** All data stored in `projects.json`, loaded into browser memory
- **Client-Side Search:** All filtering and similarity scoring runs in JavaScript
- **Data Size Limits:** Performance may degrade with >1000 projects (recommend archiving old projects)
- **Browser Storage:** localStorage has ~5-10MB limit (may need to split data across multiple JSON files)

### Data Constraints
- **Manual Data Entry:** Historical projects must be entered manually or imported from CSV
- **Data Accuracy:** Similarity scoring only as good as data quality (garbage in, garbage out)
- **Incomplete Records:** Older projects may lack detailed cost breakdowns or production rates

### User Experience Constraints
- **Learning Curve:** Similarity scoring may be unfamiliar; provide explanation tooltips
- **Subjectivity:** Users may disagree with similarity scores (allow manual override/filtering)

---

## Research Needed

The PLANNER role should investigate these areas during planning phase:

### 1. Similarity Scoring Weights
**Question:** What weights should be assigned to each similarity factor?

**Proposed Factors:**
- Project type: 30%
- Size (total feet): 25%
- Location proximity: 20%
- Soil type: 15%
- Date recency: 10%

**Research Approach:**
- Interview estimators: What factors do they consider when comparing projects?
- Analyze past bids: Which historical projects were used as references?
- Prototype testing: Build scoring algorithm, test with sample data, adjust weights

**Decision Criteria:**
- Scores should match estimator intuition ("that feels like a similar project")
- Best match should have >80% similarity for clearly comparable projects

---

### 2. Production Rate Outlier Handling
**Question:** How to detect and handle outlier projects in production rate calculations?

**Options:**
- Automatic exclusion (drop projects >2 std dev from mean)
- Flagging only (show outliers but include in calculations)
- User choice (allow user to exclude specific projects)

**Considerations:**
- Outliers may represent real challenges (rocky soil, weather delays)
- Excluding outliers could make estimates too optimistic
- Including outliers could skew averages

**Recommendation:** Flag outliers visually, allow user to toggle inclusion

---

### 3. Search Performance Optimization
**Question:** How to maintain fast search with large historical datasets?

**Performance Targets:**
- Search results in <500ms for 500 projects
- No UI freezing during filtering/sorting

**Optimization Strategies:**
- Lazy loading: Only load visible results (pagination)
- Indexing: Pre-calculate search indices on page load
- Web Workers: Run similarity scoring in background thread
- Debouncing: Delay search execution until user stops typing

**Testing:** Benchmark with 100, 500, 1000, 5000 project records

---

### 4. Data Import Format
**Question:** What CSV format should be supported for bulk historical import?

**Requirements:**
- Must map to projects.json schema
- Handle missing/optional fields gracefully
- Provide clear error messages for invalid data

**Proposed CSV Columns:**
```
Project Name, Client, City, State, Project Type, Total Feet, Bore Count, Soil Type,
Estimated Cost, Actual Cost, Start Date, End Date, Crew Size, Feet Per Day,
Challenges, Lessons Learned
```

**Validation Rules:**
- Required: Project Name, Project Type, Total Feet, Start Date
- Optional: All other fields
- Date format: YYYY-MM-DD
- Numeric fields: No commas, decimals allowed

---

## Implementation Notes

**Note:** This section will be filled in by IMPLEMENTER after module completion.

Areas to document:
- Actual similarity weights chosen and rationale
- Search performance with various dataset sizes
- Any deviations from proposed data schema
- Libraries used (Fuse.js, PapaParse) and why
- Known edge cases or limitations

---

## Known Limitations

**Note:** This section will be filled in by IMPLEMENTER after module completion.

Expected limitations to document:
- Client-side search limits dataset size to ~1000 projects
- Similarity scoring is heuristic, not mathematically proven optimal
- No automatic data import from accounting/project management software
- GPS geocoding requires external API if addresses don't have coords
- Chart.js performance degrades with >100 data points on some charts

---

## Testing Considerations

### Unit Tests (JavaScript)
- Similarity scoring algorithm (verify scores for known project pairs)
- Production rate calculations (mean, median, outlier detection)
- Search filtering (verify filter combinations work correctly)
- CSV import validation (handle malformed data gracefully)

### E2E Tests (Playwright)
- Load historical.html with sample project data
- Execute search with various filter combinations
- Verify similarity scores appear and are sortable
- Test project comparison (select 3 projects, view comparison table)
- Export search results as CSV, verify file contents
- Import CSV, verify projects added to database

### Manual Testing
- Search performance with 100, 500, 1000 projects
- Similarity score validation (do "best matches" feel right?)
- Chart rendering with various data ranges
- Cross-browser compatibility

---

## Integration Points

### With Module 2.2 (Estimate Builder)
- Completed estimates can be "saved to historical database"
- Button in estimate builder to auto-populate project data from current estimate
- Link to historical search from estimate page ("Find Similar Projects" button)

### With Module 2.3 (Proposal Generator)
- Historical comparison can be included as proposal appendix
- "Projects we've completed like this one" section with 3-5 similar projects
- Export comparison table to embed in proposal PDF

### With Module 3.3 (Change Orders)
- Historical change order frequency can inform risk assessment
- Display average change order rate for similar projects

---

## Security Considerations

- **Client-Side Only:** No server-side components, no security risks
- **Data Privacy:** Project data may contain sensitive client info; warn users before export
- **XSS Prevention:** Sanitize project names and descriptions before rendering
- **File Upload:** Validate CSV format strictly to prevent code injection

---

## Success Criteria

Module 3.2 is complete when:

1. ✅ historical.html displays project search interface
2. ✅ Advanced search filters work (type, date, location, size, soil)
3. ✅ Similarity scoring ranks projects accurately
4. ✅ Production rate analysis shows min/max/average correctly
5. ✅ Trend charts render with Chart.js (cost over time, etc.)
6. ✅ Project comparison view displays 2-5 projects side-by-side
7. ✅ CSV import/export functions work without errors
8. ✅ Search performance is acceptable (<500ms for 500 projects)
9. ✅ No JavaScript console errors in normal use
10. ✅ Integration with estimates.html ("Search Historical" link) works
11. ✅ Playwright tests verify core functionality
12. ✅ Documentation updated with implementation notes

---

**Status:** Not Started
**Next Action:** PLANNER role should research similarity scoring algorithms and create detailed implementation plan
