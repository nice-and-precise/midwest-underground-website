# Module 3.1: 3D Bore Path Visualizer

## Overview

This advanced visualization module creates an interactive 3D representation of HDD bore paths, allowing users to see depth profiles, entry/exit angles, and potential collision points with existing utilities. This module leverages Three.js for hardware-accelerated 3D graphics and transforms 2D measurement data into immersive 3D visualizations.

**Complexity Level:** ADVANCED
**Estimated Implementation:** 8-12 hours
**Research Required:** Three.js scene setup, vector mathematics for bore path calculations, collision detection algorithms

---

## Outcome

A fully interactive 3D bore path visualizer that:
- Renders HDD bore paths in 3D space with accurate depth and angles
- Shows entry/exit points, apex depth, and bore profile
- Detects and highlights potential collisions with existing utilities
- Provides camera controls (orbit, pan, zoom) for exploring the scene
- Displays depth profile graph alongside 3D view
- Exports 3D scene as screenshot or data for proposals

**User Experience:**
1. User selects a completed takeoff with HDD measurements
2. System calculates bore path from entry angle, exit angle, and total length
3. 3D scene renders showing terrain surface, bore path, and depth markers
4. User rotates/zooms to inspect bore from different angles
5. System highlights any areas where bore comes too close to existing utilities
6. User can export 3D screenshot to include in client proposals

---

## Key Behaviors

### Behavior 1: Three.js Scene Initialization
- Create WebGL-based 3D canvas using Three.js
- Set up camera (PerspectiveCamera with reasonable FOV)
- Add lighting (AmbientLight + DirectionalLight for shadows)
- Create ground plane representing terrain surface
- Add grid helper for scale reference
- Initialize OrbitControls for camera manipulation

### Behavior 2: Bore Path Calculation
- Input: Entry point (x, y, surface elevation), entry angle, exit point, exit angle, total bore length
- Calculate bore path using catenary curve or parabolic approximation
- Generate 3D coordinates for bore path curve (at least 50 points for smoothness)
- Account for real-world measurements (feet/meters)
- Create depth profile showing elevation vs horizontal distance

### Behavior 3: 3D Path Rendering
- Render bore path as TubeGeometry (hollow cylinder following curve)
- Color-code bore path by depth (shallow = green, deep = blue)
- Add marker spheres at entry point, exit point, and apex (deepest point)
- Display depth labels at key points
- Add utility markers (existing pipes/cables) from project data

### Behavior 4: Collision Detection
- Check bore path against existing utility positions (from takeoff data)
- Flag any points where bore comes within minimum clearance distance (e.g., 3 feet)
- Highlight collision zones in red
- Display warning panel listing all potential conflicts
- Calculate clearance distance at closest approach

### Behavior 5: Camera Controls & Navigation
- OrbitControls: Left-click drag to rotate, right-click drag to pan, scroll to zoom
- Preset camera views: Top view, side view, perspective view
- Reset button to return to default camera position
- Zoom to fit button to auto-frame entire bore path
- Camera animation when switching preset views

### Behavior 6: Depth Profile Visualization
- 2D line chart (Chart.js) showing depth vs horizontal distance
- X-axis: Horizontal distance from entry point
- Y-axis: Elevation/depth
- Plot terrain surface line and bore path line
- Highlight apex and any collision points
- Sync with 3D view (click on chart to highlight corresponding 3D point)

### Behavior 7: Data Export
- Screenshot export: Capture 3D canvas as PNG image
- Data export: JSON file with bore path coordinates, depth profile, collision report
- PDF report: Embed 3D screenshot + depth profile chart + collision summary
- Share URL: Generate shareable link with encoded bore path data (for client portal)

---

## Allowed Files

**Create:**
- `dashboard/bore-visualizer.html` - Main 3D visualizer page
- `dashboard/js/bore-visualizer.js` - Three.js scene management and bore calculations
- `dashboard/api/data/bore-paths.json` - Saved bore path configurations and utility data

**Modify:**
- `dashboard/takeoff.html` - Add "View in 3D" button on completed HDD takeoffs (links to bore-visualizer.html with takeoff ID)
- `dashboard/js/measurement-tools.js` - Add bore path metadata (entry angle, exit angle) to HDD measurements

**Read (Dependencies):**
- `dashboard/api/data/takeoffs.json` - Source of HDD measurement data
- `dashboard/css/dashboard.css` - Existing styles for layout consistency

---

## Dependencies

### External Libraries
- **Three.js** (r160+) - 3D graphics engine
  - CDN: `https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js`
  - Required modules: OrbitControls, TubeGeometry, CatmullRomCurve3
- **Chart.js** (already in project) - For depth profile 2D chart

### Internal Modules
- **Module 1.2 (Measurement Tools)** - Needs HDD measurement data (linear measurements with depth info)
- **Module 1.4 (Export/Persistence)** - Needs takeoffs.json structure to load measurement data

### Data Schema Requirements

**bore-paths.json:**
```json
{
  "borePaths": [
    {
      "id": "uuid",
      "takeoffId": "takeoff-123",
      "name": "Main Street Bore 1",
      "entryPoint": { "x": 0, "y": 0, "elevation": 850 },
      "exitPoint": { "x": 450, "y": 20, "elevation": 840 },
      "entryAngle": 12,
      "exitAngle": 8,
      "totalLength": 460,
      "apexDepth": 25,
      "units": "feet",
      "existingUtilities": [
        {
          "type": "water",
          "path": [[50, 0, 845], [450, 0, 845]],
          "diameter": 8,
          "color": "#0066CC"
        }
      ],
      "collisions": [
        {
          "location": { "x": 225, "y": 10, "z": 840 },
          "clearance": 2.5,
          "utility": "water",
          "severity": "warning"
        }
      ],
      "createdAt": "2025-11-22T10:00:00Z"
    }
  ]
}
```

---

## Skills Needed

### Technical Skills
- **Three.js Fundamentals** - Scene, camera, renderer, geometry, materials, lighting
- **3D Mathematics** - Vector operations, coordinate transformations, curve calculations
- **WebGL Performance** - Efficient mesh generation, level-of-detail optimization
- **Collision Detection** - Bounding sphere/box checks, distance calculations
- **Canvas API** - Screenshot export, image manipulation

### Domain Knowledge
- **HDD Bore Profiles** - Understanding of catenary curves, entry/exit angles, pull-back calculations
- **Utility Clearance Standards** - Minimum separation distances for different utility types
- **Surveying Terminology** - Elevation, horizontal distance, grade, slope

### Research Areas (To Be Investigated During Planning)
1. **Bore Path Mathematics:**
   - What is the standard curve formula for HDD bore paths?
   - How to calculate apex depth from entry angle, exit angle, and total length?
   - Should we use catenary curve, parabolic approximation, or spline interpolation?

2. **Collision Detection Algorithms:**
   - Best approach for continuous collision detection along bore path?
   - How to handle different utility geometries (pipes, cables, etc.)?
   - Performance optimization for checking thousands of points?

3. **Three.js Best Practices:**
   - Optimal scene graph structure for bore visualization?
   - How to handle very long bores (1000+ feet) without performance issues?
   - Best material/shader for depth-based color gradient?

---

## Constraints

### Technical Constraints
- **No Backend:** All calculations must run client-side in browser JavaScript
- **Performance:** Must render smoothly (30+ FPS) on mid-range laptops
- **Browser Compatibility:** Modern browsers with WebGL support (Chrome, Firefox, Safari, Edge)
- **File Size:** Three.js library adds ~600KB to page load; use CDN caching
- **Mobile Support:** Basic 3D view on tablets; may be too complex for phones

### Data Constraints
- **Source Data Accuracy:** Bore visualization is only as good as input measurements
- **Utility Data Availability:** Existing utilities must be manually mapped from takeoff or external data
- **Coordinate System:** Must align with 2D takeoff coordinate system (pixels → real-world units)

### User Experience Constraints
- **Learning Curve:** 3D navigation may be unfamiliar to some users; provide tutorial overlay
- **Validation:** System cannot validate if bore path is physically achievable (user responsibility)
- **Scope:** This is a visualization tool, NOT a bore path design/optimization tool

---

## Research Needed

The PLANNER role should investigate these areas during planning phase:

### 1. Bore Path Calculation Methods
**Question:** What mathematical formula should we use to calculate HDD bore paths?

**Options to Research:**
- Catenary curve (cable under its own weight)
- Parabolic approximation (simpler math, less accurate)
- Cubic Bezier curve (flexible, easy to control with entry/exit angles)
- Industry-standard software (what do professional HDD planners use?)

**Decision Criteria:**
- Accuracy vs computational complexity
- Ease of implementation in JavaScript
- Ability to specify entry/exit angles precisely

**Research Resources:**
- HDD industry whitepapers
- Engineering textbooks on underground construction
- Existing open-source bore planning tools

---

### 2. Three.js Scene Optimization
**Question:** How to optimize Three.js scene for long bore paths (1000+ feet)?

**Areas to Research:**
- Level-of-detail (LOD) techniques for distant portions of bore
- Instancing for repeated geometry (utility markers)
- Frustum culling (only render what camera can see)
- Texture atlas vs individual materials for color-coding

**Performance Target:** 60 FPS on Intel i5 laptop with integrated graphics

---

### 3. Collision Detection Approach
**Question:** Best algorithm for detecting bore-to-utility collisions?

**Options:**
- Bounding sphere intersection (fast, less accurate)
- Bounding box intersection (moderate speed, good accuracy)
- Exact distance calculation at each bore path point (slow, precise)
- Spatial partitioning (octree/grid) for many utilities

**Recommendation:** Start with bounding sphere, optimize if needed

---

### 4. User Interface Design
**Question:** How should users input bore path parameters?

**Options:**
- Auto-calculate from existing HDD measurements (preferred)
- Manual entry form (entry angle, exit angle, length)
- Import from external bore planning software (CSV/JSON)

**UI Considerations:**
- How to handle multiple bores on same project?
- Should users be able to edit bore path in 3D (drag entry/exit points)?
- How to display validation warnings (impossible angles, etc.)?

---

## Implementation Notes

**Note:** This section will be filled in by IMPLEMENTER after module completion.

Areas to document:
- Actual bore path formula chosen and why
- Three.js performance optimizations applied
- Collision detection algorithm details
- Any deviations from spec
- Known browser quirks or limitations

---

## Known Limitations

**Note:** This section will be filled in by IMPLEMENTER after module completion.

Expected limitations to document:
- Bore path accuracy depends on input measurement precision
- No soil condition modeling (assumes uniform soil)
- Collision detection is geometric only (doesn't account for pull-back tolerance)
- 3D view may not perform well on older hardware
- No support for compound curves (multi-segment bores)

---

## Testing Considerations

### Unit Tests (JavaScript)
- Bore path calculation functions (given entry/exit/length, verify output coordinates)
- Collision detection (verify distance calculations)
- Coordinate transformation (2D takeoff coords → 3D scene coords)

### E2E Tests (Playwright)
- Load bore-visualizer.html with sample takeoff data
- Verify 3D canvas renders without errors
- Test camera controls (orbit, zoom, preset views)
- Verify collision warnings appear when utilities too close
- Test export functionality (screenshot, data JSON)

### Manual Testing
- Visual inspection of bore path realism
- Performance testing with various bore lengths
- Cross-browser compatibility (Chrome, Firefox, Safari, Edge)
- Tablet touch controls

---

## Integration Points

### With Module 1.2 (Measurement Tools)
- HDD measurements must include entry angle and exit angle metadata
- Measurement tools should prompt for angles when user draws HDD bore path
- Store angles in takeoffs.json measurement object

### With Module 2.3 (Proposal Generator)
- Bore visualizer can export 3D screenshot to embed in proposals
- Depth profile chart can be included as project documentation
- Collision report can be formatted for client communication

### With Module 3.4 (Client Portal)
- Clients can view read-only 3D bore visualization
- Share URL feature generates client-accessible link
- No editing allowed for client users

---

## Security Considerations

- **Client-Side Only:** No server-side components, no security risks
- **Data Privacy:** All bore path data stored in browser localStorage or exported files
- **XSS Prevention:** Sanitize any user input used in UI (bore names, labels)
- **File Upload:** If supporting import of utility data, validate file format strictly

---

## Success Criteria

Module 3.1 is complete when:

1. ✅ bore-visualizer.html renders 3D scene using Three.js
2. ✅ Bore path calculation converts 2D measurements → 3D curve
3. ✅ Camera controls allow full exploration of scene
4. ✅ Depth profile chart displays alongside 3D view
5. ✅ Collision detection identifies utilities within clearance distance
6. ✅ Export functions generate screenshot and data JSON
7. ✅ Performance is acceptable (30+ FPS) on standard hardware
8. ✅ No JavaScript console errors in normal use
9. ✅ Integration with takeoff.html ("View in 3D" button) works
10. ✅ Playwright tests verify core functionality
11. ✅ Documentation updated with implementation notes

---

**Status:** Not Started
**Next Action:** PLANNER role should research bore path mathematics and create detailed implementation plan
