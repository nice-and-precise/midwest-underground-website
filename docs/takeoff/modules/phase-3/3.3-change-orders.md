# Module 3.3: Change Order Management

## Overview

This module implements a complete change order (CO) workflow system for tracking scope changes, calculating cost impacts, and managing approvals. It enables users to create change orders from existing estimates, track status, calculate deltas, and update project budgets accordingly.

**Complexity Level:** ADVANCED
**Estimated Implementation:** 6-8 hours
**Research Required:** Workflow state machines, delta calculation strategies, approval processes

---

## Outcome

A comprehensive change order management system that:
- Creates change orders linked to original estimates
- Tracks scope changes (add/remove/modify line items)
- Calculates cost and schedule impacts automatically
- Manages CO workflow (draft → submitted → approved/rejected)
- Updates estimates to reflect approved changes
- Generates change order PDF documents for client approval
- Maintains audit trail of all changes

**User Experience:**
1. User opens completed estimate and clicks "Create Change Order"
2. System creates CO draft with current estimate as baseline
3. User adds/removes/modifies line items (quantities, costs, scope)
4. System calculates delta (difference from original estimate)
5. User submits CO for approval (changes status to "submitted")
6. User or client approves/rejects CO
7. If approved, system updates estimate and budget automatically
8. User generates CO PDF document for client signature

---

## Key Behaviors

### Behavior 1: Change Order Creation
- Create new CO linked to existing estimate (via `estimate_id`)
- Initialize CO with copy of current estimate line items (baseline)
- Assign unique CO number (auto-increment: CO-001, CO-002, etc.)
- Set initial status: "draft"
- Capture creation metadata: Created by, created date, reason for change
- Allow user to enter change description and justification

### Behavior 2: Scope Change Interface
- Display original estimate line items alongside CO line items
- Support three change types:
  - **Add:** New line item not in original estimate (mark as "ADDED")
  - **Remove:** Delete line item from original estimate (mark as "REMOVED", quantity = 0)
  - **Modify:** Change quantity or unit cost of existing line item (mark as "MODIFIED")
- Color-code changes: Green = added, red = removed, yellow = modified
- Show side-by-side comparison: Original vs Changed
- Real-time delta calculation as user makes changes

### Behavior 3: Delta Calculation Engine
- Calculate cost delta for each modified line item:
  - **Modified quantity:** `(new_qty - old_qty) × unit_cost`
  - **Modified unit cost:** `new_qty × (new_cost - old_cost)`
  - **Added item:** `+new_qty × new_cost`
  - **Removed item:** `-old_qty × old_cost`
- Aggregate deltas by cost category (labor, equipment, materials, subs)
- Calculate total CO value (sum of all deltas)
- Display delta as: Dollar amount (+$5,200) and percentage (+8.3%)
- Calculate new project total: `original_estimate + total_delta`

### Behavior 4: Schedule Impact Tracking
- Allow user to enter estimated schedule impact (added days)
- Display original completion date and revised completion date
- Link schedule impact to specific scope changes (which items add time?)
- Show critical path changes (if applicable)
- Calculate daily cost impact (if schedule extends, are there daily crew costs?)

### Behavior 5: CO Workflow State Machine
- **States:**
  - `draft` - Being edited, not visible to client
  - `submitted` - Submitted for approval, no further edits
  - `approved` - Client/PM approved, estimate updated
  - `rejected` - Client/PM rejected, CO archived
  - `withdrawn` - Created in error, cancelled before submission
- **Transitions:**
  - Draft → Submitted (user clicks "Submit for Approval")
  - Submitted → Approved (user clicks "Approve CO")
  - Submitted → Rejected (user clicks "Reject CO")
  - Draft → Withdrawn (user clicks "Cancel CO")
- **Rules:**
  - Cannot edit CO after submission (unless reset to draft)
  - Cannot delete approved COs (audit trail)
  - Approved COs automatically update linked estimate

### Behavior 6: Estimate Update on Approval
- When CO approved, system updates original estimate:
  - Add new line items from CO
  - Update quantities/costs for modified items
  - Remove deleted items (or set quantity to 0)
  - Recalculate estimate totals
  - Add note to estimate: "Updated by CO-XXX on [date]"
- Preserve original estimate in archive (before CO applied)
- Create new estimate revision number (e.g., Rev 1.0 → Rev 1.1)
- Update project budget if linked to accounting system

### Behavior 7: Change Order PDF Generation
- Generate professional CO document (using jsPDF)
- Include:
  - CO number and date
  - Project name and client
  - Original estimate reference (number, date, total)
  - Change description and justification
  - Line-item comparison table (original vs changed)
  - Delta summary by category
  - Total CO value and new project total
  - Schedule impact (if any)
  - Signature blocks (client, PM)
- Brand with Midwest Underground logo and formatting
- Export as PDF for client approval

### Behavior 8: Change Order History & Audit Trail
- Display all COs for a project in chronological order
- Show CO number, date, status, total delta
- Click to view CO details (full comparison table)
- Track version history (if CO is edited before submission)
- Record approval/rejection actions with timestamp and user
- Export CO log as CSV (for accounting/project management)

---

## Allowed Files

**Create:**
- `dashboard/change-orders.html` - Change order management interface
- `dashboard/js/change-orders.js` - CO workflow logic, delta calculations, PDF generation
- `dashboard/api/data/change-orders.json` - Change order database

**Modify:**
- `dashboard/estimates.html` - Add "Create Change Order" button on completed estimates
- `dashboard/js/estimate-builder.js` - Add function to apply approved CO to estimate
- `dashboard/proposals.html` - Add option to include CO history in proposal appendix

**Read (Dependencies):**
- `dashboard/api/data/estimates.json` - Source of original estimate data
- `dashboard/templates/proposal-template.js` - Reuse PDF formatting for CO documents
- `dashboard/css/dashboard.css` - Existing styles for layout consistency

---

## Dependencies

### External Libraries
- **jsPDF** (already in project) - For change order PDF generation
- **Chart.js** (optional) - For visual delta comparison (bar chart of category changes)

### Internal Modules
- **Module 2.2 (Estimate Builder)** - REQUIRED - Needs estimates to create COs from
- **Module 2.3 (Proposal Generator)** - PDF template patterns to reuse
- **Module 1.4 (Export/Persistence)** - Data export patterns to follow

### Data Schema Requirements

**change-orders.json:**
```json
{
  "changeOrders": [
    {
      "id": "uuid",
      "coNumber": "CO-001",
      "projectId": "project-123",
      "estimateId": "estimate-456",
      "status": "approved",
      "createdBy": "John Doe",
      "createdAt": "2025-06-15T10:00:00Z",
      "submittedAt": "2025-06-15T14:00:00Z",
      "approvedAt": "2025-06-16T09:00:00Z",
      "approvedBy": "Client Name",
      "description": "Additional bore required due to utility conflicts",
      "justification": "Unforeseen utilities discovered during site survey",
      "originalEstimate": {
        "id": "estimate-456",
        "number": "EST-2025-123",
        "date": "2025-05-01",
        "total": 85000,
        "lineItems": [
          {
            "id": "item-1",
            "category": "HDD",
            "description": "2-inch HDPE conduit bore",
            "quantity": 450,
            "unit": "feet",
            "unitCost": 35,
            "total": 15750
          }
        ]
      },
      "changes": [
        {
          "changeType": "add",
          "lineItem": {
            "id": "item-new-1",
            "category": "HDD",
            "description": "Additional 2-inch bore (new route)",
            "quantity": 200,
            "unit": "feet",
            "unitCost": 35,
            "total": 7000
          },
          "delta": 7000
        },
        {
          "changeType": "modify",
          "originalLineItem": {
            "id": "item-1",
            "quantity": 450,
            "unitCost": 35,
            "total": 15750
          },
          "newLineItem": {
            "id": "item-1",
            "quantity": 650,
            "unitCost": 35,
            "total": 22750
          },
          "delta": 7000
        }
      ],
      "deltasByCategory": {
        "labor": 4200,
        "equipment": 2800,
        "materials": 0,
        "subcontractors": 0,
        "total": 7000
      },
      "newEstimateTotal": 92000,
      "scheduleImpact": {
        "addedDays": 2,
        "originalCompletion": "2025-06-30",
        "revisedCompletion": "2025-07-02",
        "reason": "Additional bore adds 2 crew days"
      },
      "notes": "Client approved via email on 2025-06-16",
      "pdfUrl": "path/to/CO-001.pdf"
    }
  ]
}
```

---

## Skills Needed

### Technical Skills
- **State Machine Design** - Define CO workflow states and transitions
- **Delta Calculations** - Accurately compute cost differences
- **PDF Generation** - jsPDF for professional documents
- **Data Synchronization** - Update estimates when CO approved
- **Version Control** - Track estimate revisions after COs

### Domain Knowledge
- **Construction Change Orders** - Standard CO format and content
- **Approval Workflows** - Who approves COs? What triggers approval?
- **Cost Impact Analysis** - Direct costs vs indirect costs (overhead, profit)

### Research Areas (To Be Investigated During Planning)
1. **Workflow Complexity:**
   - Should there be multi-level approval (PM → Client)?
   - How to handle partial approvals (approve some items, reject others)?
   - What if client requests changes to the CO itself?

2. **Estimate Versioning:**
   - Should we create a new estimate or modify existing one?
   - How to preserve history (before/after CO)?
   - What if multiple COs are applied to same estimate?

3. **Delta Calculation Edge Cases:**
   - How to handle negative COs (reducing scope)?
   - What if unit cost changes (market price fluctuation)?
   - How to represent combo changes (quantity up, unit cost down)?

---

## Constraints

### Technical Constraints
- **No Backend:** All CO data stored in `change-orders.json`, loaded into browser
- **Client-Side Workflow:** State transitions run in JavaScript (no server validation)
- **Synchronization:** Must keep estimates and COs in sync (no database transactions)
- **Audit Trail:** All CO history stored in JSON (file size grows over time)

### Business Constraints
- **Approval Authority:** System cannot enforce who can approve (client-side only)
- **Legal Validity:** CO PDFs are for convenience, not legally binding without signatures
- **No Email Integration:** Cannot auto-send CO PDFs to clients (manual process)

### User Experience Constraints
- **Learning Curve:** CO workflow may be unfamiliar to users; provide tutorial/help
- **Error Prevention:** Hard to undo approved CO (once estimate updated)

---

## Research Needed

The PLANNER role should investigate these areas during planning phase:

### 1. Change Order Workflow Design
**Question:** What workflow states and transitions should the system support?

**Proposed Workflow:**
```
Draft → Submitted → Approved/Rejected
  ↓
Withdrawn (from draft only)
```

**Research Questions:**
- Should there be "In Review" state between Submitted and Approved?
- Can approved COs be "voided" if applied in error?
- How to handle COs that are approved with modifications?

**Decision Criteria:**
- Keep workflow simple for MVP (can expand later)
- Match real-world CO process at construction companies

---

### 2. Estimate Update Strategy
**Question:** When CO is approved, should we modify original estimate or create new revision?

**Option A: Modify in place**
- Pros: Simple, one estimate per project
- Cons: Lose original baseline, hard to compare

**Option B: Create revision**
- Pros: Preserve history, clear audit trail
- Cons: More complex, need revision numbering system

**Recommendation:** Create revision (Rev 1.0, 1.1, 1.2) but keep estimate_id same

---

### 3. Delta Calculation Rules
**Question:** How to handle complex scenarios in delta calculation?

**Scenarios to Define:**
- Negative CO (reducing scope): Display as negative delta, subtract from total
- Quantity increase + unit cost decrease: Calculate net delta correctly
- Removing item then re-adding it: Should be treated as modify, not add+remove
- Rounding errors: How to handle penny differences in calculations?

**Validation Rules:**
- Total delta = sum of all line item deltas (must balance)
- New estimate total = original total + total delta (must match)

---

### 4. PDF Document Format
**Question:** What should change order PDF include?

**Proposed Sections:**
1. Header: CO number, date, project name, client
2. Original Estimate Summary: Reference number, date, total
3. Change Description: Reason, justification
4. Line Item Comparison Table: Original vs Changed (with deltas highlighted)
5. Delta Summary: By category, total
6. New Project Total: Original + delta
7. Schedule Impact: Added days, revised completion
8. Signature Blocks: Client, PM, date
9. Footer: Page numbers, company info

**Visual Design:** Match proposal template formatting for brand consistency

---

## Implementation Notes

**Note:** This section will be filled in by IMPLEMENTER after module completion.

Areas to document:
- Actual workflow states implemented
- Delta calculation algorithm details
- How estimate versioning was handled
- Any deviations from spec
- Known edge cases or limitations

---

## Known Limitations

**Note:** This section will be filled in by IMPLEMENTER after module completion.

Expected limitations to document:
- Cannot enforce approval authority (client-side system)
- No integration with accounting/ERP systems
- CO PDFs require manual signature (no e-signature integration)
- Cannot undo approved CO without manual estimate editing
- Limited to single-level approval workflow (no multi-step approvals)

---

## Testing Considerations

### Unit Tests (JavaScript)
- Delta calculation for add/modify/remove scenarios
- Workflow state transitions (verify valid/invalid transitions)
- Estimate update logic (verify line items updated correctly)
- CO numbering (verify auto-increment works)

### E2E Tests (Playwright)
- Create CO from existing estimate
- Add/modify/remove line items, verify delta calculations
- Submit CO (status changes to submitted)
- Approve CO (status changes to approved, estimate updated)
- Generate CO PDF, verify content
- View CO history for project

### Manual Testing
- Complex delta scenarios (negative COs, combo changes)
- Estimate versioning after multiple COs
- PDF formatting and branding
- Cross-browser compatibility

---

## Integration Points

### With Module 2.2 (Estimate Builder)
- "Create Change Order" button on completed estimates
- `applyChangeOrderToEstimate()` function updates estimate when CO approved
- Display CO history on estimate detail page

### With Module 2.3 (Proposal Generator)
- Include CO summary in proposal appendix (if COs exist)
- Reuse proposal PDF formatting for CO documents
- Show "includes CO-XXX changes" note on proposals

### With Module 3.2 (Historical Database)
- Track change order frequency in historical projects
- Display average CO rate for similar projects (risk assessment)

---

## Security Considerations

- **Client-Side Only:** No server-side components, no security risks
- **Data Privacy:** CO data may contain sensitive pricing; warn before export
- **XSS Prevention:** Sanitize CO descriptions and justifications before rendering
- **Approval Fraud:** Cannot prevent unauthorized approvals (client-side system)

---

## Success Criteria

Module 3.3 is complete when:

1. ✅ change-orders.html displays CO management interface
2. ✅ CO creation links to existing estimate correctly
3. ✅ Add/modify/remove line items work without errors
4. ✅ Delta calculations are accurate (verified with test cases)
5. ✅ Workflow state machine transitions correctly
6. ✅ Approved COs update linked estimate automatically
7. ✅ CO PDF generation produces professional documents
8. ✅ CO history displays all COs for project chronologically
9. ✅ No JavaScript console errors in normal use
10. ✅ Integration with estimates.html ("Create CO" button) works
11. ✅ Playwright tests verify core functionality
12. ✅ Documentation updated with implementation notes

---

**Status:** Not Started
**Next Action:** PLANNER role should research CO workflows and create detailed implementation plan
