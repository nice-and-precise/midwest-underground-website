# Module 3.4: Client Portal

## Overview

This module creates a simplified client-facing portal where clients can log in, view their projects, review and approve proposals, and upload files. This is a **basic authentication system** suitable for low-security use cases only - NOT production-grade security for sensitive data.

**Complexity Level:** ADVANCED
**Estimated Implementation:** 8-10 hours
**Research Required:** Client-side authentication patterns, file upload handling, access control

**⚠️ SECURITY WARNING:** This module uses **client-side only** authentication (localStorage tokens). This is NOT secure for production use with sensitive data. Suitable for convenience/demo purposes only.

---

## Outcome

A basic client portal system that:
- Allows clients to log in with email/password (stored in JSON)
- Displays client's projects (linked via client ID)
- Shows proposals for review and approval
- Enables file uploads (plans, permits, photos)
- Provides read-only access to takeoffs and estimates
- Logs client activity (viewed proposal, uploaded file)
- Supports client logout and session management

**User Experience:**
1. Client receives email with portal URL and credentials
2. Client navigates to `dashboard/client-portal.html` and logs in
3. Portal displays client's active projects
4. Client clicks project to view details (scope, timeline, budget)
5. Client views proposal PDF and clicks "Approve Proposal"
6. Client uploads site plans or permits via file upload
7. Client logs out when done

---

## Key Behaviors

### Behavior 1: Simple Authentication System
- **Login Form:**
  - Email and password fields
  - "Login" button (validates credentials against `clients.json`)
  - "Forgot Password" link (displays contact info, no password reset)
- **Authentication Logic:**
  - Check if email exists in `clients.json`
  - Compare password (plaintext comparison - NOT SECURE, demo only)
  - On success: Generate simple session token (UUID), store in localStorage
  - On failure: Display "Invalid email or password" error
- **Session Management:**
  - Store token in localStorage: `clientPortalToken`
  - Store client ID and name: `clientPortalUser`
  - Check token on page load (if invalid/missing, redirect to login)
  - "Logout" button clears localStorage and redirects to login

**⚠️ WARNING:** Passwords stored in plaintext in JSON. Session tokens stored in localStorage (not httpOnly cookies). This is **extremely insecure** and suitable ONLY for demonstration purposes.

### Behavior 2: Client Dashboard
- Display welcome message: "Welcome, [Client Name]"
- List client's projects in card layout:
  - Project name
  - Status (estimating, proposed, active, completed)
  - Key metrics (total cost, start date, completion %)
  - "View Details" button
- Show recent activity feed:
  - "Proposal for Project X sent on [date]"
  - "File uploaded: site-plan.pdf on [date]"
  - "Proposal approved on [date]"
- Display notifications (if any):
  - "New proposal awaiting your review"
  - "Change order CO-001 requires approval"

### Behavior 3: Project Detail View
- **Project Info:**
  - Project name, location, description
  - Timeline (start date, estimated completion, actual completion)
  - Budget (estimated cost, approved changes, total)
  - Status indicator (visual badge: green = active, yellow = pending, gray = completed)
- **Tabs:**
  - **Overview:** Project description, scope summary
  - **Proposal:** View proposal PDF, approve/reject buttons
  - **Takeoff:** Read-only view of measurements and quantities (no editing)
  - **Files:** List of uploaded files (plans, permits, photos) with download links
  - **Activity:** Timeline of project events (proposal sent, file uploaded, CO approved)

### Behavior 4: Proposal Viewer & Approval
- **View Proposal:**
  - Embed proposal PDF in iframe or PDF.js viewer
  - Display proposal details: Number, date, total cost, line items
  - Show approval status: Pending, Approved, Rejected
- **Approval Actions:**
  - "Approve Proposal" button (changes status to "approved", logs timestamp and client)
  - "Reject Proposal" button (changes status to "rejected", prompts for reason)
  - Confirmation dialog: "Are you sure you want to approve this $85,000 proposal?"
- **Post-Approval:**
  - Display "Approved on [date] by [client name]" badge
  - Disable approve/reject buttons (cannot change once approved)
  - Send notification to Midwest Underground (log entry, no email integration)

### Behavior 5: File Upload System
- **Upload Interface:**
  - Drag-and-drop zone or "Choose Files" button
  - Support multiple file types: PDF, PNG, JPG, DWG, CSV
  - File size limit: 10MB per file (client-side validation)
  - Preview uploaded files (thumbnails for images, icons for documents)
- **Upload Process:**
  - Convert file to base64 string (for client-side storage)
  - Store in `clients.json` under client's project files array
  - Generate unique file ID and timestamp
  - Display success message: "File uploaded successfully"
- **File Management:**
  - List all uploaded files in table (name, type, size, upload date)
  - Download button (convert base64 back to file, trigger download)
  - Delete button (only for client who uploaded, or admin)
- **File Categories:**
  - Site Plans
  - Permits
  - Photos
  - Other Documents

**⚠️ WARNING:** Storing files as base64 in JSON is inefficient and has size limits (~5-10MB total localStorage). Suitable for small files only.

### Behavior 6: Read-Only Takeoff View
- Display takeoff measurements from linked project
- Show PDF plan with measurement overlays (read-only)
- Display quantity totals by category
- No editing allowed (client can view but not modify)
- "Request Changes" button (opens contact form)

### Behavior 7: Activity & Audit Log
- Track client actions:
  - Logged in
  - Viewed project details
  - Viewed proposal
  - Approved/rejected proposal
  - Uploaded file
  - Downloaded file
  - Logged out
- Display activity in reverse chronological order
- Show timestamp, action description, user
- Store in `clients.json` under client's activity log

### Behavior 8: Access Control
- **Client-Level Access:**
  - Client can only see their own projects (filter by client ID)
  - Cannot view other clients' projects or data
  - Cannot access admin features (cost database, historical projects)
- **Project-Level Access:**
  - Client can view projects they are assigned to
  - Can view proposals, upload files, approve proposals
  - Cannot edit estimates, create change orders, or delete data
- **Read-Only Enforcement:**
  - All client portal views are read-only by default
  - Approval buttons are the only write actions allowed
  - File upload is additive only (no deletion of Midwest Underground files)

---

## Allowed Files

**Create:**
- `dashboard/client-portal.html` - Client portal login and dashboard
- `dashboard/js/client-auth.js` - Authentication logic and session management
- `dashboard/js/client-portal.js` - Portal UI logic (dashboard, project view, file upload)
- `dashboard/api/data/clients.json` - Client accounts, sessions, activity logs

**Modify:**
- `dashboard/proposals.html` - Add "Share with Client" button to generate portal link
- `dashboard/api/data/proposals.json` - Add `clientApprovalStatus` field

**Read (Dependencies):**
- `dashboard/api/data/takeoffs.json` - For read-only takeoff view
- `dashboard/api/data/estimates.json` - For read-only estimate view
- `dashboard/api/data/proposals.json` - For proposal viewing and approval
- `dashboard/css/dashboard.css` - Existing styles (may need client-specific overrides)

---

## Dependencies

### External Libraries
- **PDF.js** (already in project) - For proposal PDF viewing
- None (uses vanilla JavaScript for simplicity)

### Internal Modules
- **Module 2.3 (Proposal Generator)** - REQUIRED - Needs proposals to share with clients
- **Module 1.4 (Export/Persistence)** - Takeoff data to display read-only
- **Module 2.2 (Estimate Builder)** - Estimate data to display read-only

### Data Schema Requirements

**clients.json:**
```json
{
  "clients": [
    {
      "id": "uuid",
      "name": "City of Willmar",
      "email": "jdoe@willmar.mn.us",
      "password": "demo123",
      "phone": "(320) 555-1234",
      "contactPerson": "John Doe",
      "projects": [
        {
          "projectId": "project-123",
          "projectName": "Fiber Ring Phase 2",
          "status": "active",
          "estimatedCost": 125000,
          "startDate": "2025-05-01",
          "completionPercent": 45,
          "proposalId": "proposal-456",
          "takeoffId": "takeoff-789",
          "estimateId": "estimate-101",
          "files": [
            {
              "id": "file-1",
              "name": "site-plan.pdf",
              "type": "application/pdf",
              "size": 245678,
              "category": "Site Plans",
              "uploadedBy": "John Doe",
              "uploadedAt": "2025-06-10T14:30:00Z",
              "base64Data": "data:application/pdf;base64,JVBERi0xLjQK..."
            }
          ]
        }
      ],
      "sessions": [
        {
          "token": "uuid-token",
          "createdAt": "2025-06-15T10:00:00Z",
          "expiresAt": "2025-06-15T18:00:00Z",
          "ipAddress": "192.168.1.100",
          "userAgent": "Mozilla/5.0..."
        }
      ],
      "activityLog": [
        {
          "timestamp": "2025-06-15T10:05:00Z",
          "action": "logged_in",
          "details": "Successful login"
        },
        {
          "timestamp": "2025-06-15T10:10:00Z",
          "action": "viewed_proposal",
          "details": "Viewed proposal PROP-2025-123"
        },
        {
          "timestamp": "2025-06-15T10:15:00Z",
          "action": "approved_proposal",
          "details": "Approved proposal PROP-2025-123 ($125,000)"
        }
      ],
      "createdAt": "2025-05-01T09:00:00Z",
      "lastLogin": "2025-06-15T10:00:00Z"
    }
  ]
}
```

---

## Skills Needed

### Technical Skills
- **Client-Side Authentication** - Token generation, session management, localStorage
- **Access Control Logic** - Filter data by client ID, enforce read-only rules
- **File Upload Handling** - FileReader API, base64 encoding, size validation
- **PDF Embedding** - PDF.js integration, iframe embedding
- **UI State Management** - Track login status, current project, active tab

### Security Knowledge (CRITICAL)
- **⚠️ Understanding of Security Limitations:**
  - Client-side authentication is NOT secure
  - Passwords in JSON are NOT encrypted
  - localStorage tokens are NOT httpOnly
  - Client can manipulate data via browser console
  - This is suitable ONLY for low-stakes demo/convenience use
- **When to Use This Approach:**
  - Internal tool for trusted users
  - Proof-of-concept or MVP
  - Low-security data (non-sensitive project info)
- **When NOT to Use This Approach:**
  - Production systems with real client data
  - Any sensitive information (SSNs, financial data, etc.)
  - Compliance requirements (GDPR, HIPAA, PCI-DSS)

### Research Areas (To Be Investigated During Planning)
1. **File Storage Strategy:**
   - Base64 in JSON works for small files, but what's the limit?
   - Should we implement file chunking for larger files?
   - Alternative: External file hosting (Dropbox, Google Drive API)?

2. **Session Expiration:**
   - How long should sessions last? (8 hours? 24 hours? Never?)
   - Should we implement "remember me" functionality?
   - How to handle expired sessions gracefully?

3. **Approval Workflow:**
   - Can clients un-approve proposals after approval?
   - Should approvals require reason/notes?
   - How to notify Midwest Underground of approvals?

---

## Constraints

### Technical Constraints
- **No Backend:** All authentication runs client-side (extremely insecure)
- **localStorage Limits:** ~5-10MB total storage (limits file uploads)
- **No Email Integration:** Cannot auto-send login credentials or approval notifications
- **Browser Storage:** Client data only accessible from same browser/device

### Security Constraints (CRITICAL)
- **⚠️ NOT PRODUCTION READY:** This is a demonstration/convenience tool only
- **No Encryption:** Passwords and data stored in plaintext JSON
- **No HTTPS Enforcement:** Even if deployed on HTTPS, client-side auth is insecure
- **Session Hijacking Risk:** Tokens stored in localStorage are vulnerable
- **Data Tampering:** Client can edit localStorage and bypass access controls

### User Experience Constraints
- **Single Device:** Client must use same browser/device (no sync across devices)
- **No Password Reset:** Forgot password requires contacting Midwest Underground
- **Limited File Types:** Only supports common file types (PDF, images, DWG)
- **File Size Limits:** 10MB per file, total localStorage ~5-10MB

---

## Research Needed

The PLANNER role should investigate these areas during planning phase:

### 1. File Upload Size Limits
**Question:** What is the practical limit for base64 file storage in localStorage?

**Research Approach:**
- Test uploading files of increasing size (1MB, 5MB, 10MB, 20MB)
- Monitor localStorage usage in browser DevTools
- Identify point where browser throws quota errors
- Determine if file chunking is needed

**Decision:** Set client-side file size limit based on testing results

---

### 2. Session Management
**Question:** How to handle session expiration and refresh?

**Options:**
- **No Expiration:** Session lasts forever (until logout or localStorage cleared)
- **Time-Based:** Session expires after 8 hours of inactivity
- **Activity-Based:** Session extends on any action (sliding window)

**Recommendation:** 8-hour time-based expiration with warning at 7:45

---

### 3. Proposal Approval Workflow
**Question:** What happens after client approves proposal?

**Actions to Implement:**
- Update proposal status to "approved"
- Record approval timestamp and client name
- Log activity in client activity log
- Display confirmation message
- Notify Midwest Underground (how? Email? Dashboard notification?)

**Decision:** For MVP, just update status and log activity. Email notifications are future enhancement.

---

### 4. Access Control Edge Cases
**Question:** How to handle clients assigned to multiple projects?

**Scenarios:**
- Client works for municipality with 10 projects over 5 years
- Client should see all their projects, but no one else's
- What if project is shared between two clients (joint venture)?

**Solution:** Filter projects by client ID, support multiple clients per project (array of client IDs)

---

## Implementation Notes

**Note:** This section will be filled in by IMPLEMENTER after module completion.

Areas to document:
- Actual file size limits discovered through testing
- Session expiration strategy implemented
- Any security warnings added to UI
- Deviations from spec
- Known vulnerabilities or limitations

---

## Known Limitations

**Note:** This section will be filled in by IMPLEMENTER after module completion.

Expected limitations to document:
- Client-side authentication is **NOT SECURE** (cannot stress this enough)
- Passwords stored in plaintext (visible in clients.json)
- Session tokens in localStorage (vulnerable to XSS)
- No password hashing, no HTTPS enforcement, no CSRF protection
- File uploads limited by localStorage quota (~5-10MB total)
- No cross-device sync (localStorage is browser-specific)
- No email notifications (requires backend)
- Cannot prevent data tampering via browser console

---

## Testing Considerations

### Unit Tests (JavaScript)
- Authentication logic (valid/invalid credentials)
- Session token generation and validation
- File upload size validation
- Base64 encoding/decoding
- Access control filtering (client only sees own projects)

### E2E Tests (Playwright)
- Login with valid credentials (success)
- Login with invalid credentials (failure)
- View project dashboard (correct projects displayed)
- View proposal PDF
- Approve proposal (status updates correctly)
- Upload file (appears in file list)
- Download file (file contents correct)
- Logout (localStorage cleared)

### Security Testing
- **⚠️ Demonstrate Vulnerabilities:**
  - Open browser console, read clients.json, extract all passwords
  - Modify localStorage token, access other client's data
  - Inject malicious script via file upload (test XSS prevention)
- **Document in Known Limitations:** This is a teaching opportunity about security

### Manual Testing
- Cross-browser compatibility (Chrome, Firefox, Safari, Edge)
- Mobile/tablet responsiveness
- File upload with various file types and sizes
- Session expiration behavior

---

## Integration Points

### With Module 2.3 (Proposal Generator)
- "Share with Client" button generates portal link with project ID
- Proposal approval updates proposal status in proposals.json
- Link to proposal PDF from client portal

### With Module 1.4 (Export/Persistence)
- Read-only access to takeoff data from takeoffs.json
- Display measurements and quantities (no editing)

### With Module 3.3 (Change Orders)
- Clients can view and approve change orders (future enhancement)
- CO approval workflow similar to proposal approval

---

## Security Considerations (CRITICAL)

### ⚠️ WARNING: This Module Is NOT Secure

**DO NOT use this module for:**
- Production systems with real client data
- Any sensitive information (financial data, personal info, etc.)
- Compliance-regulated industries (healthcare, finance, etc.)
- Public-facing websites with untrusted users

**This module is suitable ONLY for:**
- Internal proof-of-concept
- Demonstration/training purposes
- Low-security convenience tool for trusted users
- Development/testing environments

### Known Security Vulnerabilities

1. **Plaintext Passwords:** Anyone with access to clients.json can read all passwords
2. **Client-Side Auth:** All authentication runs in browser (easily bypassed)
3. **localStorage Tokens:** Session tokens are visible and modifiable
4. **No Encryption:** All data stored unencrypted in JSON files
5. **XSS Vulnerability:** File uploads may contain malicious scripts
6. **CSRF Risk:** No CSRF token protection for actions
7. **No Rate Limiting:** Brute-force login attacks are possible
8. **Session Fixation:** Tokens are predictable UUIDs (not cryptographically random)

### Mitigation (For Production Use)
To make this secure, you would need:
- Backend server with database (PostgreSQL, MySQL)
- Bcrypt password hashing (never store plaintext)
- HTTP-only cookies for session tokens
- HTTPS/TLS encryption in transit
- CSRF protection (tokens on state-changing requests)
- Rate limiting on login endpoint
- Server-side access control validation
- File upload to secure storage (S3, Azure Blob)
- Security headers (CSP, X-Frame-Options, etc.)
- Regular security audits and penetration testing

**Bottom Line:** This module demonstrates concepts only. Real client portal requires backend infrastructure and proper security.

---

## Success Criteria

Module 3.4 is complete when:

1. ✅ client-portal.html displays login form
2. ✅ Authentication validates credentials against clients.json
3. ✅ Client dashboard displays only client's own projects
4. ✅ Project detail view shows all tabs (overview, proposal, takeoff, files, activity)
5. ✅ Proposal viewer displays PDF and approval buttons work
6. ✅ File upload accepts files, converts to base64, stores in JSON
7. ✅ File download reconstructs file from base64 correctly
8. ✅ Activity log tracks all client actions
9. ✅ Logout clears session and redirects to login
10. ✅ Security warnings displayed prominently in UI and docs
11. ✅ No JavaScript console errors in normal use
12. ✅ Playwright tests verify core functionality
13. ✅ Documentation clearly states security limitations

---

**Status:** Not Started
**Next Action:** PLANNER role should research file upload strategies and create detailed implementation plan

**⚠️ FINAL WARNING:** Document security limitations clearly. This is a learning/demo tool, NOT production-ready.
