# Module P0.3: Test Harness Setup (Playwright E2E)

## Overview

This module establishes the Playwright end-to-end testing infrastructure for the entire takeoff system. It creates a sample test, verifies screenshot capture, and documents testing conventions that will be used across all 14 remaining modules.

**Phase:** Phase 0 - Platform Scaffolding
**Status:** Not Started
**Created:** 2025-11-22

---

## Outcome

A fully functional Playwright test infrastructure that provides:

1. **Test Framework Setup**
   - Playwright installed and configured
   - `playwright.config.js` with proper settings for takeoff app
   - Test scripts in package.json for easy execution

2. **Sample Test**
   - `tests/takeoff/sample.spec.js` demonstrating:
     - Page navigation
     - Element interaction
     - Screenshot capture
     - Assertion patterns

3. **Test Conventions Documentation**
   - File naming standards
   - Test structure patterns
   - Screenshot comparison approach
   - Test data management

**What This Module Will Build:**
- Confidence that Playwright is working correctly
- Foundation for all Phase 1-3 E2E tests
- Clear testing patterns for future module tests

---

## Key Behaviors

### Test Execution
- **Browser Automation** - Playwright controls Chrome/Firefox/Safari
- **Screenshot Comparison** - Visual regression testing for UI changes
- **Element Selectors** - Consistent approach to finding elements (data-testid preferred)
- **Async/Await** - All tests use modern async patterns

### Test Organization
- **Per-Module Test Files** - Each module gets dedicated .spec.js file
- **Fixture Data** - Sample PDFs and test data in `tests/fixtures/`
- **Page Objects** - Reusable page interaction helpers (for complex modules)

### CI/CD Ready
- **Headless Execution** - Tests run without browser UI (for CI)
- **Parallel Execution** - Multiple tests run simultaneously
- **Retry Logic** - Flaky tests retry up to 2x
- **Video Recording** - Failures captured on video for debugging

---

## Allowed Files

### Create
- `playwright.config.js` - Playwright configuration
- `tests/takeoff/sample.spec.js` - Sample test demonstrating patterns
- `tests/fixtures/sample-plan.pdf` - Sample PDF for testing (if needed)
- `docs/takeoff/TESTING-CONVENTIONS.md` - Testing standards and patterns
- `.gitignore` entries for test-results and screenshots

### Modify
- `package.json` - Add Playwright dependency and test scripts
- `docs/takeoff/TESTING.md` - Add Playwright setup and usage examples

### Read (for reference)
- `docs/takeoff/TESTING.md` - Existing testing strategy
- `.claude/takeoff-system.md` - Architecture context
- `CLAUDE-TAKEOFF.md` - Entry point

---

## Dependencies

### External Dependencies
- **Playwright** - `npm install -D @playwright/test` (will be installed)
- **Node.js 18+** - Already installed
- **Modern browsers** - Chrome, Firefox, Safari (Playwright auto-installs)

### Internal Dependencies
- **P0.1 Complete** ✅ - Testing documentation must exist
- **P0.2 Complete** ⏳ - Serena wiring for potential test state storage
- **Local dev server** - Takeoff app running on http://localhost:3000

### Enables These Modules
- **Phase 1 Modules (1.1-1.4)** - PDF viewer, measurement tools, calculator, persistence tests
- **Phase 2 Modules (2.1-2.4)** - Cost database, estimate builder, proposal generator, dashboard tests
- **Phase 3 Modules (3.1-3.4)** - Bore visualizer, historical database, change orders, client portal tests

---

## Skills Needed

### Primary Skills
1. **Playwright API** - Page navigation, element interaction, assertions
2. **JavaScript Testing** - Async/await, test structure, mocking
3. **Browser DevTools** - Inspecting elements, network tab, console debugging
4. **Visual Testing** - Screenshot comparison, baseline management

### Secondary Skills
1. **CSS Selectors** - Finding elements when data-testid not available
2. **Test Data Management** - Fixtures, mocks, sample files
3. **CI/CD** - Headless execution, parallel testing

---

## Constraints

### Scope Constraints
- **Sample Test Only** - This module creates ONE sample test, not comprehensive suite
- **Infrastructure Focus** - Goal is to validate Playwright works, not test all features
- **No Complex Scenarios** - Simple navigation and screenshot test is sufficient

### Technical Constraints
- **Playwright Only** - No Jest, Mocha, or other frameworks (Playwright has built-in runner)
- **Modern Browsers** - Support Chrome 120+, Edge 120+, Firefox 120+ (Safari optional)
- **No Visual Diff Tools** - Use Playwright's built-in screenshot comparison

### Testing Constraints
- **Local Execution** - CI/CD integration deferred to later (not in Platform Scaffolding)
- **Manual Baseline** - Screenshot baselines approved manually (not automated)
- **No Performance Tests** - E2E functional tests only (performance deferred)

---

## Implementation Plan Outline

### Task 1: Install and Configure Playwright
**Goal:** Get Playwright installed and configured for takeoff app
**Files:**
- Modify `package.json` (add dependency and scripts)
- Create `playwright.config.js`

**Configuration:**
- Base URL: http://localhost:3000
- Test directory: tests/takeoff/
- Browsers: chromium, firefox
- Screenshots: on failure
- Video: on first retry
- Retries: 2

**Success Criteria:**
- `npm run test:e2e` command works
- Playwright installs browsers successfully
- Config file loads without errors

---

### Task 2: Create Sample Test
**Goal:** Working test that demonstrates core patterns
**Files:**
- Create `tests/takeoff/sample.spec.js`

**Test Scenarios:**
1. **Homepage Load Test**
   - Navigate to http://localhost:3000
   - Verify page title
   - Take screenshot

2. **Element Interaction Test** (if applicable)
   - Click a button or link
   - Verify navigation or state change
   - Take screenshot

**Success Criteria:**
- Test runs without errors
- Screenshots saved to test-results/
- All assertions pass

---

### Task 3: Verify Screenshot Capture
**Goal:** Confirm visual regression testing works
**Files:**
- `tests/takeoff/sample.spec.js` (enhance with screenshot assertions)

**Screenshot Tests:**
- Capture baseline screenshot
- Run test again (should match baseline)
- Intentionally break UI (e.g., change text)
- Verify Playwright detects difference

**Success Criteria:**
- Baseline screenshots saved
- Comparison mode works
- Diff images generated on mismatch

---

### Task 4: Document Testing Conventions
**Goal:** Clear standards for all future tests
**Files:**
- Create `docs/takeoff/TESTING-CONVENTIONS.md`
- Update `docs/takeoff/TESTING.md`

**Conventions to Document:**
- **File Naming:** `{module-id}.spec.js` (e.g., `pdf-viewer.spec.js`)
- **Test Structure:** describe → it blocks
- **Selectors:** Prefer `data-testid` attributes
- **Fixtures:** Store in `tests/fixtures/`
- **Screenshots:** Name with test name prefix

**Success Criteria:**
- Conventions document is clear and actionable
- Examples provided for each convention
- Links to Playwright best practices

---

### Task 5: Create Test Scripts
**Goal:** Easy commands for running tests
**Files:**
- Modify `package.json` (add scripts section)

**Scripts to Add:**
```json
{
  "scripts": {
    "test:e2e": "playwright test",
    "test:e2e:debug": "playwright test --debug",
    "test:e2e:ui": "playwright test --ui",
    "test:e2e:headed": "playwright test --headed",
    "test:e2e:report": "playwright show-report"
  }
}
```

**Success Criteria:**
- All scripts execute without errors
- Debug mode opens Playwright inspector
- UI mode opens interactive test runner
- Report shows test results

---

## Validation Checklist

Before marking this module complete:

- [ ] Playwright installed (`npm list @playwright/test` shows version)
- [ ] `playwright.config.js` created and valid
- [ ] Sample test file `tests/takeoff/sample.spec.js` created
- [ ] Sample test passes (`npm run test:e2e` exits 0)
- [ ] Screenshots captured to `test-results/` directory
- [ ] Screenshot comparison works (baseline vs actual)
- [ ] Testing conventions documented
- [ ] Test scripts in package.json work
- [ ] No errors in console output
- [ ] Test report generated and viewable

---

## Known Limitations

### Not Testing
- **Performance metrics** - Load time, memory usage (deferred to performance testing module)
- **Accessibility** - WCAG compliance (could be added later with axe-core)
- **Mobile devices** - Only desktop browsers (mobile emulation possible but not required)

### Current Scope
- **One sample test** - Comprehensive test coverage comes in Phase 1-3 modules
- **No CI/CD** - Local execution only (CI integration deferred)
- **No test parallelization** - Single worker (can be parallelized later if needed)

### Future Enhancements
- **Visual regression service** - Percy or Chromatic for cloud screenshot comparison
- **Accessibility testing** - Integrate @axe-core/playwright
- **API mocking** - MSW (Mock Service Worker) for backend API tests
- **Performance testing** - Lighthouse CI integration

---

## Testing

**Test Type:** E2E (Playwright)

**Sample Test File:** `tests/takeoff/sample.spec.js`

**How to Run:**
```bash
# Run all tests (headless)
npm run test:e2e

# Run with browser UI visible
npm run test:e2e:headed

# Debug mode (step through test)
npm run test:e2e:debug

# Interactive UI mode
npm run test:e2e:ui

# View test report
npm run test:e2e:report
```

**Expected Results:**
- Sample test passes
- Screenshots saved to `test-results/screenshots/`
- HTML report generated at `playwright-report/index.html`
- No console errors

**Validation:**
- Run test twice → same result (idempotent)
- Break UI → test fails with screenshot diff
- Fix UI → test passes again

---

## Related Documentation

- **Testing Strategy:** `docs/takeoff/TESTING.md`
- **Testing Conventions:** `docs/takeoff/TESTING-CONVENTIONS.md` (created by this module)
- **Test Results:** `docs/takeoff/TEST-RESULTS.md`
- **Architecture:** `docs/takeoff/ARCHITECTURE.md`
- **Playwright Docs:** https://playwright.dev/

---

## Example Test Structure

```javascript
// tests/takeoff/sample.spec.js
import { test, expect } from '@playwright/test';

test.describe('Takeoff System Sample Test', () => {
  test.beforeEach(async ({ page }) => {
    // Navigate to takeoff app before each test
    await page.goto('/');
  });

  test('should load homepage', async ({ page }) => {
    // Verify page title
    await expect(page).toHaveTitle(/Takeoff/);

    // Take screenshot
    await page.screenshot({
      path: 'test-results/screenshots/homepage.png',
      fullPage: true
    });
  });

  test('should capture element screenshot', async ({ page }) => {
    // Find element by test ID
    const header = page.locator('[data-testid="app-header"]');

    // Verify element exists
    await expect(header).toBeVisible();

    // Screenshot specific element
    await header.screenshot({
      path: 'test-results/screenshots/header.png'
    });
  });
});
```

---

## Next Module

**Module 1.1: PDF Viewer**
- Integrate PDF.js library
- Load and render construction plans
- Zoom, pan, page navigation
- Foundation for measurement tools

**Dependency:** P0.3 must be complete (this module) - test infrastructure ready

---

**Created:** 2025-11-22
**Status:** Not Started
**Next Step:** PLANNER creates implementation plan for P0.3
