<!-- TOC -->

## Table of Contents

  - [Overview](#overview)
  - [Outcome](#outcome)
  - [Key Behaviors](#key-behaviors)
    - [Memory Persistence](#memory-persistence)
    - [Memory Structure](#memory-structure)
    - [Error Handling](#error-handling)
  - [Allowed Files](#allowed-files)
    - [Create](#create)
    - [Modify](#modify)
    - [Read (for reference)](#read-for-reference)
  - [Dependencies](#dependencies)
    - [External Dependencies](#external-dependencies)
    - [Internal Dependencies](#internal-dependencies)
    - [Enables These Modules](#enables-these-modules)
  - [Skills Needed](#skills-needed)
    - [Primary Skills](#primary-skills)
    - [Secondary Skills](#secondary-skills)
  - [Constraints](#constraints)
    - [Scope Constraints](#scope-constraints)
    - [Technical Constraints](#technical-constraints)
    - [Testing Constraints](#testing-constraints)
  - [Implementation Plan Outline](#implementation-plan-outline)
    - [Task 1: Create Memory Write Test](#task-1-create-memory-write-test)
    - [Task 2: Create Memory Read Test](#task-2-create-memory-read-test)
    - [Task 3: Session Persistence Test](#task-3-session-persistence-test)
    - [Task 4: Document Usage Patterns](#task-4-document-usage-patterns)
    - [Task 5: Troubleshooting Guide](#task-5-troubleshooting-guide)
  - [Validation Checklist](#validation-checklist)
  - [Known Limitations](#known-limitations)
    - [Not Testing](#not-testing)
    - [Future Enhancements](#future-enhancements)
  - [Testing](#testing)
- [Step 1: Write test data](#step-1-write-test-data)
- [Step 2: Read and validate](#step-2-read-and-validate)
- [Step 3: Persistence test (requires agent restart)](#step-3-persistence-test-requires-agent-restart)
- [Follow on-screen instructions to restart agent](#follow-on-screen-instructions-to-restart-agent)
  - [Related Documentation](#related-documentation)
  - [Next Module](#next-module)

<!-- /TOC -->

# Module P0.2: Serena MCP Wiring and Validation

## Overview

This module validates that Serena MCP (Model Context Protocol) memory persistence is working correctly for the takeoff system. It ensures that memory state survives across agent sessions, enabling autonomous multi-agent execution without losing context.

**Phase:** Phase 0 - Platform Scaffolding
**Status:** Not Started
**Created:** 2025-11-22

---

## Outcome

A validated Serena MCP integration that provides:

1. **Persistent Memory Storage**
   - Three primary memories created and tested:
     - `takeoff-system-context` - Overall system state
     - `takeoff-progress-tracker` - Module completion tracking
     - `takeoff-module-{ID}-state` - Individual module states

2. **Memory Read/Write Validation**
   - Test scripts that write to Serena memory
   - Test scripts that read from Serena memory across sessions
   - Validation that memory persists after agent restart

3. **Documentation**
   - Usage examples for reading/writing Serena memories
   - Memory structure documentation
   - Troubleshooting guide for memory issues

**What This Module Will Build:**
- Confidence that Serena MCP is reliable for autonomous execution
- Test scripts for validating memory persistence
- Documentation for future memory usage patterns

---

## Key Behaviors

### Memory Persistence
- **Write → Read → Validate** - Test scripts write data, read it back, verify accuracy
- **Session Boundary Test** - Verify memory survives agent restart
- **Concurrent Access** - Multiple agents can read same memory without corruption

### Memory Structure
- **System Context Memory** - Overall takeoff system state, module completion status
- **Progress Tracker Memory** - Linear history of all module work
- **Module State Memories** - Per-module planning/implementation/testing state

### Error Handling
- **Graceful Degradation** - If Serena unavailable, agents can still work (with warnings)
- **Retry Logic** - Transient failures retry 3x before failing
- **Clear Error Messages** - Memory access failures explain what went wrong

---

## Allowed Files

### Create
- `tests/serena/memory-write-test.js` - Script to write test data to Serena
- `tests/serena/memory-read-test.js` - Script to read and validate memory
- `tests/serena/memory-persistence-test.js` - End-to-end persistence validation
- `docs/takeoff/serena/MEMORY-USAGE.md` - Usage examples and patterns
- `docs/takeoff/serena/TROUBLESHOOTING.md` - Common issues and solutions

### Modify
- `docs/takeoff/MEMORY.md` - Add validation results and usage examples

### Read (for reference)
- `docs/takeoff/MEMORY.md` - Existing memory documentation
- `.claude/takeoff-system.md` - Architecture context
- `CLAUDE-TAKEOFF.md` - Entry point

---

## Dependencies

### External Dependencies
- **Serena MCP** - Must be installed and connected
- **Node.js** - For running test scripts (already installed)

### Internal Dependencies
- **P0.1 Complete** ✅ - Memory documentation must exist
- `.claude/takeoff-system.md` - Defines memory structure
- `docs/takeoff/MEMORY.md` - Documents three memory types

### Enables These Modules
- **P0.3** - Test Harness (can use Serena for test state)
- **All Phase 1-3 modules** - Rely on Serena for state persistence

---

## Skills Needed

### Primary Skills
1. **Serena MCP API** - Understanding read_memory/write_memory tool syntax
2. **Node.js Scripting** - Writing test scripts in JavaScript
3. **Session Management** - Understanding agent session lifecycle
4. **Data Validation** - Verifying memory contents match expectations

### Secondary Skills
1. **Error Handling** - Graceful degradation when Serena unavailable
2. **Documentation** - Clear usage examples for future agents
3. **Debugging** - Troubleshooting memory access issues

---

## Constraints

### Scope Constraints
- **Validation Only** - This module tests existing Serena setup, doesn't build new features
- **No UI** - Command-line test scripts only
- **Three Memories** - Only test the three defined memory types (system, progress, module-state)

### Technical Constraints
- **Serena MCP Protocol** - Must use Serena's MCP tools (read_memory, write_memory)
- **No Database** - Serena is the only persistent storage in Platform Scaffolding phase
- **Text-Only** - Memories store markdown/JSON text, no binary data

### Testing Constraints
- **Manual Execution** - Test scripts run manually, not in CI/CD yet
- **Agent Restart Required** - Persistence test requires stopping and starting agent
- **No Automation** - This module doesn't create Playwright tests (that's P0.3)

---

## Implementation Plan Outline

### Task 1: Create Memory Write Test
**Goal:** Script that writes test data to all three memory types
**Files:**
- Create `tests/serena/memory-write-test.js`

**Test Data:**
- System context: `takeoff-system-context` with test state
- Progress tracker: `takeoff-progress-tracker` with test entry
- Module state: `takeoff-module-P0.2-state` with test status

**Success Criteria:**
- Script runs without errors
- Serena confirms writes successful
- Can manually verify memory contents in Serena logs

---

### Task 2: Create Memory Read Test
**Goal:** Script that reads and validates memory contents
**Files:**
- Create `tests/serena/memory-read-test.js`

**Validation:**
- Read all three test memories
- Compare contents to expected values
- Print PASS/FAIL for each memory

**Success Criteria:**
- Script reads all three memories successfully
- Data matches what was written in Task 1
- Clear output showing validation results

---

### Task 3: Session Persistence Test
**Goal:** Validate memory survives agent restart
**Files:**
- Create `tests/serena/memory-persistence-test.js`

**Steps:**
1. Write unique timestamp to test memory
2. Print "STOP AGENT NOW" message
3. On restart, read memory and verify timestamp
4. Print PASS if timestamp matches

**Success Criteria:**
- Memory survives agent restart
- Data is identical after restart
- No corruption or loss

---

### Task 4: Document Usage Patterns
**Goal:** Create clear examples for future memory usage
**Files:**
- Create `docs/takeoff/serena/MEMORY-USAGE.md`
- Update `docs/takeoff/MEMORY.md`

**Content:**
- Code examples for read/write
- Common patterns (update progress, check module state)
- Best practices (when to write, how often)

**Success Criteria:**
- Examples are copy-paste ready
- Covers all three memory types
- Includes error handling examples

---

### Task 5: Troubleshooting Guide
**Goal:** Document common Serena issues and solutions
**Files:**
- Create `docs/takeoff/serena/TROUBLESHOOTING.md`

**Common Issues:**
- "Memory not found" error
- Serena connection timeout
- Memory write failures
- Session state loss

**Success Criteria:**
- Each issue has clear solution
- Includes diagnostic commands
- Links to Serena MCP documentation

---

## Validation Checklist

Before marking this module complete:

- [ ] Test scripts created and executable
- [ ] `memory-write-test.js` successfully writes to all three memories
- [ ] `memory-read-test.js` successfully reads and validates data
- [ ] `memory-persistence-test.js` confirms survival across agent restart
- [ ] Usage documentation created with examples
- [ ] Troubleshooting guide created
- [ ] All tests passing
- [ ] No errors in Serena logs
- [ ] Memory structure matches docs/takeoff/MEMORY.md specification

---

## Known Limitations

### Not Testing
- **Concurrent writes** - Multiple agents writing to same memory simultaneously
- **Large data volumes** - Memories are text-based, not designed for massive data
- **Memory migration** - Changing memory structure after data written

### Future Enhancements
- **Memory versioning** - Track schema changes over time
- **Automated backup** - Periodic snapshots of critical memories
- **Memory size limits** - Monitoring and alerts for large memories

---

## Testing

**Test Type:** Manual validation scripts

**Test Scripts:**
1. `tests/serena/memory-write-test.js` - Write test data
2. `tests/serena/memory-read-test.js` - Read and validate
3. `tests/serena/memory-persistence-test.js` - Session boundary test

**How to Run:**
```bash
# Step 1: Write test data
node tests/serena/memory-write-test.js

# Step 2: Read and validate
node tests/serena/memory-read-test.js

# Step 3: Persistence test (requires agent restart)
node tests/serena/memory-persistence-test.js
# Follow on-screen instructions to restart agent
```

**Expected Results:**
- All scripts print "PASS" status
- No errors in console
- Serena logs show successful read/write operations

**No Playwright tests** - This is infrastructure validation, not UI testing

---

## Related Documentation

- **Memory Structure:** `docs/takeoff/MEMORY.md`
- **Architecture:** `docs/takeoff/ARCHITECTURE.md`
- **Master Plan:** `.claude/takeoff-system.md`
- **Serena MCP Docs:** (link to official Serena documentation)

---

## Next Module

**Module P0.3: Test Harness Setup**
- Playwright E2E test infrastructure
- Sample test that captures screenshots
- Test configuration and conventions
- Foundation for all Phase 1-3 testing

**Dependency:** P0.2 must be complete (this module)

---

**Created:** 2025-11-22
**Status:** Not Started
**Next Step:** PLANNER creates implementation plan for P0.2
